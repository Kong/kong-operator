package main

import (
	"fmt"
	"os"

	"github.com/kong/kubernetes-testing-framework/pkg/utils/kubernetes/kubectl"

	"github.com/kong/kong-operator/v2/test/helpers/kcfg"
)

// Generates CRDs for Helm Chart charts/kong-operator/templates/validating-policy-dataplane.yaml.
func main() {
	const autoGenerationComment = "# This file is auto-generated by KO's hack/generators/validating-policy/main.go generator.\n"

	const chartCRDsFilePath = "charts/kong-operator/templates/validation-policy-dataplane.yaml"
	webhookKustomize, err := kubectl.RunKustomize(kcfg.ValidatingPoliciesPath())
	if err != nil {
		fmt.Printf("Failed to run kustomize for webhook: %v", err)
	}

	crdContent := string(webhookKustomize)
	crdContent = wrapInIfEnabled(crdContent)
	crdContent = wrapInIfCapabilitiesExist(crdContent)

	var fileCRDs *os.File
	fileCRDs, err = os.Create(chartCRDsFilePath)
	if err != nil {
		fmt.Printf("Failed to create %s: %v\n", chartCRDsFilePath, err)
		os.Exit(1)
	}

	for _, content := range []string{autoGenerationComment, crdContent} {
		if _, err := fileCRDs.WriteString(content); err != nil {
			fmt.Printf("Failed to write to %s: %v\n", chartCRDsFilePath, err)
			os.Exit(1)
		}
	}
	fileCRDs.Close()

	fmt.Println("Successfully finished")
}

func wrapInIfEnabled(v string) string {
	// NOTE: This values.yaml field path must match the one in
	// https://github.com/Kong/kong-operator/blob/f981b357ff58dd71ff2f5eac1330f3f1693d2734/charts/kong-operator/values.yaml#L140
	return fmt.Sprintf("{{- if .Values.global.validatingPolicies.dataplanePorts.enabled }}\n%s\n{{- end -}}\n", v)
}

func wrapInIfCapabilitiesExist(v string) string {
	// NOTE: This values.yaml field path must match the one in
	// https://github.com/Kong/kong-operator/blob/f981b357ff58dd71ff2f5eac1330f3f1693d2734/charts/kong-operator/values.yaml#L140
	return fmt.Sprintf("{{- if and (.Capabilities.APIVersions.Has \"admissionregistration.k8s.io/v1/ValidatingAdmissionPolicy\") (.Capabilities.APIVersions.Has \"admissionregistration.k8s.io/v1/ValidatingAdmissionPolicyBinding\") -}}\n%s\n{{- end -}}\n", v)
}
