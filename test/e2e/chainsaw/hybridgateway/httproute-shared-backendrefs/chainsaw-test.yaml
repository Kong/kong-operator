# HTTPRoute Shared BackendRefs test scenario
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: httproute-shared-backendrefs
spec:
  description: |
    This test validates that the Hybrid Gateway controller correctly reuses KongService
    resources when multiple HTTPRoutes share the same backendRefs set and properly updates
    the gateway-operator.konghq.com/hybrid-routes annotation when routes are deleted or updated.

  bindings:
    # Common bindings - using chainsaw-provided $namespace.
    - name: test_name
      value: ($namespace)
    - name: kong_namespace
      value: ($namespace)

    - name: konnect_token
      value: (env('KONNECT_TOKEN'))
    - name: konnect_url
      value: (env('KONNECT_SERVER_URL') || 'eu.api.konghq.tech')
    - name: gateway_image
      value: (env('GATEWAY_IMAGE') || 'kong/kong-gateway:3.12')

    - name: gateway_name
      value: (join('-', [($test_name), 'gateway']))
    - name: gateway_namespace
      value: ($namespace)

    - name: sni_hostname
      value: (join('.', ['*', ($test_name), 'example.com']))
    - name: cert_secret_name
      value: test-tls-secret
    - name: cert_secret_namespace
      value: ($namespace)
    - name: listener_https_port
      value: 443
    - name: listener_http_port
      value: 80

    - name: httproute_one_name
      value: shared-backends-one
    - name: httproute_two_name
      value: shared-backends-two
    - name: httproute_three_name
      value: shared-backends-three
    - name: httproute_one_path
      value: /shared-backends-one
    - name: httproute_two_path
      value: /shared-backends-two
    - name: httproute_three_path
      value: /shared-backends-three

    - name: http_method
      value: "GET"
    - name: host_header
      value: ""

    - name: operator_namespace
      value: kong-system

    - name: echo_deployment_namespace
      value: ($namespace)

  steps:
    # Step 1: Create the TLS secret that will be referenced by the Gateway TLS listener.
    - name: Create-tls-secret
      description: Create TLS Secret for the Gateway TLS listener.
      use:
        template: ../../common/_step_templates/apply-assert-tlsSecret.yaml

    # Step 2: Create the KonnectAPIAuthConfiguration to authenticate with Konnect.
    - name: Create-konnect-api-auth
      description: Create KonnectAPIAuthConfiguration for the test.
      use:
        template: ../../common/_step_templates/apply-assert-konnectAPIAuthConfiguration.yaml

    # Step 3: Create the GatewayConfiguration that defines the hybrid gateway setup.
    - name: Create-gateway-configuration
      description: Create GatewayConfiguration for the test.
      use:
        template: ../../common/_step_templates/apply-assert-gatewayConfiguration.yaml

    # Step 4: Create the GatewayClass that will be used by the Gateway.
    - name: Create-gateway-class
      description: Create GatewayClass for the test.
      use:
        template: ../../common/_step_templates/apply-assert-gatewayClass.yaml

    # Step 5: Create the Gateway with a TLS listener that references the TLS secret.
    - name: Create-gateway
      description: Create Gateway with TLS listener for the test.
      use:
        template: ../../common/_step_templates/apply-assert-gateway.yaml

    # Step 6: Verify that the KonnectGatewayControlPlane is created and synchronized with Konnect.
    - name: Assert-konnect-gateway-control-plane
      description: Assert that the KonnectGatewayControlplane resource is created and synchronized.
      use:
        template: ../../common/_step_templates/assert-konnectGatewayControlPlane.yaml

    # Step 7: Verify that the KongCertificate resource is created from the TLS secret.
    - name: Assert-kong-certificate
      description: Assert that the KongCertificate resource is created for the TLS secret.
      use:
        template: ../../common/_step_templates/assert-kongCertificate.yaml

    # Step 8: Verify that the KongSNI resource is created for the SNI hostname.
    - name: Assert-kong-sni
      description: Assert that the KongSNI resource is created for the SNI hostname.
      use:
        template: ../../common/_step_templates/assert-kongSNI.yaml
      bindings:
      - name: resource_type
        value: "kongcertificates.configuration.konghq.com"

    # Step 9: Create the echo service that will receive the routed traffic.
    - name: Create-echo-service
      description: Create and assert an echo service to route traffic to.
      use:
        template: ../../common/_step_templates/apply-assert-echoService.yaml
        with:
          bindings:
            - name: echo_deployment_name
              value: echo

    # Step 10: Create the secondary echo service for shared backends.
    - name: Create-echo-secondary-service
      description: Create and assert a secondary echo service.
      use:
        template: ../../common/_step_templates/apply-assert-echoService.yaml
        with:
          bindings:
            - name: echo_deployment_name
              value: echo-secondary

    # Step 11: Create 3 HTTPRoutes sharing the same backendRefs set.
    - name: create-httproutes-shared-backendrefs
      description: Create 3 HTTPRoutes sharing the same backendRefs set
      try:
        - apply:
            file: 01-httproutes.yaml
        - assert:
            file: 02-assert-httproutes.yaml

    # Step 12: Assert KongService for route one.
    - name: assert-kongservice-route-one
      description: Assert KongService for route one
      use:
        template: ../../common/_step_templates/assert-kongService.yaml
      bindings:
        - name: http_route_name
          value: ($httproute_one_name)
        - name: http_route_namespace
          value: ($kong_namespace)

    # Step 13: Assert KongService for route two.
    - name: assert-kongservice-route-two
      description: Assert KongService for route two
      use:
        template: ../../common/_step_templates/assert-kongService.yaml
      bindings:
        - name: http_route_name
          value: ($httproute_two_name)
        - name: http_route_namespace
          value: ($kong_namespace)

    # Step 14: Assert KongService for route three.
    - name: assert-kongservice-route-three
      description: Assert KongService for route three
      use:
        template: ../../common/_step_templates/assert-kongService.yaml
      bindings:
        - name: http_route_name
          value: ($httproute_three_name)
        - name: http_route_namespace
          value: ($kong_namespace)

    # Step 15: Verify traffic for route one.
    - name: verify-traffic-route-one
      description: Verify route one serves traffic
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: ($httproute_one_path)
        - name: listener_http_port
          value: "80"

    # Step 16: Verify traffic for route two.
    - name: verify-traffic-route-two
      description: Verify route two serves traffic
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: ($httproute_two_path)
        - name: listener_http_port
          value: "80"

    # Step 17: Verify traffic for route three.
    - name: verify-traffic-route-three
      description: Verify route three serves traffic
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: ($httproute_three_path)
        - name: listener_http_port
          value: "80"

    # Step 18: Delete one HTTPRoute and verify traffic still works for remaining routes.
    - name: delete-httproute-two
      description: Delete route two and verify it no longer serves traffic
      try:
        - delete:
            ref:
              apiVersion: gateway.networking.k8s.io/v1
              kind: HTTPRoute
              namespace: ($kong_namespace)
              name: ($httproute_two_name)

    # Step 19: Verify route one still serves traffic after deletion.
    - name: verify-traffic-after-delete-route-one
      description: Verify route one still serves traffic after deletion
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: ($httproute_one_path)
        - name: listener_http_port
          value: "80"

    # Step 20: Verify route three still serves traffic after deletion.
    - name: verify-traffic-after-delete-route-three
      description: Verify route three still serves traffic after deletion
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: ($httproute_three_path)
        - name: listener_http_port
          value: "80"

    # Step 21: Update route three to use different backendRefs.
    - name: update-remaining-httproute-backendrefs
      description: Update route three to use a different backendRefs set
      try:
        - apply:
            file: 03-update-httproute.yaml
        - assert:
            file: 04-assert-updated-httproute.yaml

    # Step 22: Assert KongService for route one after update.
    - name: assert-kongservice-route-one-after-update
      description: Assert KongService for route one after update
      use:
        template: ../../common/_step_templates/assert-kongService.yaml
      bindings:
        - name: http_route_name
          value: ($httproute_one_name)
        - name: http_route_namespace
          value: ($kong_namespace)

    # Step 23: Assert KongService for route three after update.
    - name: assert-kongservice-route-three-after-update
      description: Assert KongService for route three after update
      use:
        template: ../../common/_step_templates/assert-kongService.yaml
      bindings:
        - name: http_route_name
          value: ($httproute_three_name)
        - name: http_route_namespace
          value: ($kong_namespace)

    # Step 24: Verify route one still serves traffic after update.
    - name: verify-traffic-final-route-one
      description: Verify route one still serves traffic after update
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: ($httproute_one_path)
        - name: listener_http_port
          value: "80"

    # Step 25: Verify route three still serves traffic after update.
    - name: verify-traffic-final-route-three
      description: Verify route three still serves traffic after update
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: ($httproute_three_path)
        - name: listener_http_port
          value: "80"

  catch:
    # Capture debug snapshot on test failure for CI debugging.
    - description: Capture debug snapshot
      script:
        env:
          - name: TEST_NAME
            value: hybridgateway-httproute-shared-backendrefs
          - name: NAMESPACE
            value: ($namespace)
          - name: OPERATOR_NAMESPACE
            value: kong-system
        content: |
          bash ../../common/scripts/debug_snapshot.sh
