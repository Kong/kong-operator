# HTTPRoute Path Matching test scenario
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: httproute-path-matching
spec:
  description: |
    This test validates HTTPRoute path matching scenarios including PathPrefix,
    Exact, multiple path matches in a single rule, and the strip-path annotation.

  bindings:
    - name: test_name
      value: ($namespace)
    - name: namespace
      value: ($namespace)
    - name: konnect_api_auth_name
      value: konnect-api-auth-dev-1
    - name: konnect_token
      value: (env('KONNECT_TOKEN'))
    - name: konnect_url
      value: (env('KONNECT_SERVER_URL') || 'eu.api.konghq.tech')
    - name: gateway_image
      value: (env('GATEWAY_IMAGE') || 'kong/kong-gateway:3.12')
    - name: gateway_class_name
      value: (join('-', [($test_name), 'gateway-class']))
    - name: gateway_configuration_name
      value: (join('-', [($test_name), 'gateway-configuration']))
    - name: gateway_namespace
      value: ($namespace)
    - name: gateway_name
      value: (join('-', [($namespace), 'gateway']))
    - name: http_route_namespace
      value: ($namespace)
    - name: httpbin_service_name
      value: httpbin
    - name: httpbin_service_namespace
      value: ($namespace)
    - name: httpbin_deployment_name
      value: httpbin
    - name: httpbin_deployment_namespace
      value: ($namespace)
    - name: httpbin_service_port
      value: 80
    - name: listener_http_port
      value: 80
    - name: request_headers
      value: ""

    # Unique HTTPRoute names for each test scenario
    - name: httproute_name_pathprefix
      value: (join('-', [($namespace), 'pathprefix']))
    - name: httproute_name_pathexact
      value: (join('-', [($namespace), 'pathexact']))
    - name: httproute_name_multipaths
      value: (join('-', [($namespace), 'multipaths']))
    - name: httproute_name_strippath
      value: (join('-', [($namespace), 'strippath']))

  timeouts:
    apply: 120s
    assert: 120s
    cleanup: 120s
    delete: 120s

  steps:
  # Step 1: Create test namespace
  - name: 1-create-namespace
    description: Create namespace for test resources
    use:
      template: ../../common/_step_templates/apply-assert-namespace.yaml
    bindings:
      - name: namespace_name
        value: ($namespace)

  # Step 2: Create KonnectAPIAuthConfiguration
  - name: 2-create-konnect-api-auth
    description: Create KonnectAPIAuthConfiguration for the test
    use:
      template: ../../common/_step_templates/apply-assert-konnectAPIAuthConfiguration.yaml

  # Step 3: Create GatewayConfiguration
  - name: 3-create-gateway-configuration
    description: Create GatewayConfiguration for the test
    use:
      template: ../../common/_step_templates/apply-assert-gatewayConfiguration.yaml

  # Step 4: Create GatewayClass
  - name: 4-create-gateway-class
    description: Create GatewayClass for the test
    use:
      template: ../../common/_step_templates/apply-assert-gatewayClass.yaml

  # Step 5: Create httpbin service
  - name: 5-create-httpbin-service
    description: Create httpbin service for backend
    use:
      template: ../../common/_step_templates/apply-assert-httpbinService.yaml

  # Step 6: Create Gateway
  - name: 6-create-gateway
    description: Create Gateway for HTTP traffic
    use:
      template: ../../common/_step_templates/apply-assert-gateway-http-only.yaml

  # Step 7a: Create HTTPRoute with PathPrefix matching
  - name: 7a-create-httproute-pathprefix
    description: Create HTTPRoute with PathPrefix /status and GET method
    bindings:
      - name: httproute_name
        value: ($httproute_name_pathprefix)
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/status"
    try:
      - apply:
          file: 06-httproute-pathprefix.yaml
      - assert:
          file: 06-assert-httproute-pathprefix.yaml

  # Step 7b: Verify PathPrefix matching works
  - name: 7b-verify-pathprefix-matching
    description: Verify /status/200 matches PathPrefix and returns 200
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/status/200"
      - name: http_method
        value: "GET"
      - name: host_header
        value: ""
      - name: expected_status
        value: "200"

  # Step 8a: Create HTTPRoute with Exact path matching
  - name: 8a-create-httproute-pathexact
    description: Create HTTPRoute with Exact path /post and POST method
    bindings:
      - name: httproute_name
        value: ($httproute_name_pathexact)
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/post"
    try:
      - apply:
          file: 07-httproute-pathexact.yaml
      - assert:
          file: 07-assert-httproute-pathexact.yaml

  # Step 8b: Verify Exact path matching works
  - name: 8b-verify-pathexact-match
    description: Verify /post matches Exact path and returns 200
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/post"
      - name: http_method
        value: "POST"
      - name: host_header
        value: ""
      - name: expected_status
        value: "200"

  # Step 8c: Verify Exact path does NOT match subpaths
  - name: 8c-verify-pathexact-no-subpath
    description: Verify /post/subpath does NOT match Exact path and returns 404
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/post/subpath"
      - name: http_method
        value: "POST"
      - name: host_header
        value: ""
      - name: expected_status
        value: "404"

  # Step 9a: Create HTTPRoute with multiple path matches in single rule
  - name: 9a-create-httproute-multipaths
    description: Create HTTPRoute with multiple path matches (Exact and PathPrefix) in one rule
    bindings:
      - name: httproute_name
        value: ($httproute_name_multipaths)
      - name: gateway_name
        value: ($gateway_name)
    try:
      - apply:
          file: 08-httproute-multipaths.yaml
      - assert:
          file: 08-assert-httproute-multipaths.yaml

  # Step 9b: Verify Exact path match
  - name: 9b-verify-multipaths-put
    description: Verify /put matches (Exact path in multi-path rule)
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/put"
      - name: http_method
        value: "PUT"
      - name: host_header
        value: ""
      - name: expected_status
        value: "200"

  # Step 9c: Verify PathPrefix match with /anything
  - name: 9c-verify-multipaths-anything
    description: Verify /anything matches (PathPrefix in multi-path rule)
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/anything"
      - name: http_method
        value: "PUT"
      - name: host_header
        value: ""
      - name: expected_status
        value: "200"

  # Step 9d: Verify PathPrefix match with /anything/foo
  - name: 9d-verify-multipaths-anything-foo
    description: Verify /anything/foo matches (PathPrefix in multi-path rule)
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/anything/foo"
      - name: http_method
        value: "PUT"
      - name: host_header
        value: ""
      - name: expected_status
        value: "200"

  # Step 9e: Verify unmatched path returns 404
  - name: 9e-verify-multipaths-nomatch
    description: Verify /headers does NOT match any path and returns 404
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/headers"
      - name: http_method
        value: "PUT"
      - name: host_header
        value: ""
      - name: expected_status
        value: "404"

  # Step 10a: Create HTTPRoute with strip-path annotation
  - name: 10a-create-httproute-strippath
    description: Create HTTPRoute with PathPrefix /strip and strip-path annotation
    bindings:
      - name: httproute_name
        value: ($httproute_name_strippath)
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/strip"
    try:
      - apply:
          file: 09-httproute-strippath.yaml
      - assert:
          file: 09-assert-httproute-strippath.yaml

  # Step 10b: Verify strip-path with /delete
  - name: 10b-verify-strippath-delete
    description: Verify /strip/delete routes to /delete on backend (path stripped)
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/strip/delete"
      - name: http_method
        value: "DELETE"
      - name: host_header
        value: ""
      - name: expected_status
        value: "200"

  # Step 10c: Verify strip-path with /anything
  - name: 10c-verify-strippath-anything
    description: Verify /strip/anything routes to /anything on backend (path stripped)
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name)
      - name: route_path
        value: "/strip/anything"
      - name: http_method
        value: "DELETE"
      - name: host_header
        value: ""
      - name: expected_status
        value: "200"
