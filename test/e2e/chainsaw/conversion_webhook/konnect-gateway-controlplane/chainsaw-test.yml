# Test converting KonnectGatewayControlPlane from v1alpha1 to v2alpha1 by webhook.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: konnect-gateway-controlplane-conversion
spec:
  description: |
    This test validates that the v1alpha1 KonnectGatewayControlPlane is converted to v2alpha1.

  bindings:
    - name: test_name
      value: ($namespace)
    - name: konnect_api_auth_name
      value: (join('-', [($test_name), 'konnect-api-auth']))
    - name: konnect_gateway_controlplane_name
      value: (join('-', [($test_name), 'konnect-gateway-controlplane']))

  steps:
    - name: create-konnect-resources
      description: Create KonnectGatewayControlPlane and KonnectAPIAuthConfiguration resources
      try:
        - apply:
            file: 00-konnect-gateway-controlplane.yml
        - assert:
            file: 00-assert-konnect-gateway-controlplane.yml

  catch:
    # Capture debug snapshot on test failure for CI debugging.
    - description: Capture debug snapshot
      script:
        env:
          - name: TEST_NAME
            value: conversion-webhook-konnect-gateway-controlplane
          - name: NAMESPACE
            value: ($namespace)
          - name: OPERATOR_NAMESPACE
            value: kong-system
        content: |
          bash ../../common/scripts/debug_snapshot.sh
