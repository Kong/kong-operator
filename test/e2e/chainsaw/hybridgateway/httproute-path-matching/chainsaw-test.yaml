# HTTPRoute Path Matching test scenario
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: httproute-path-matching
spec:
  description: |
    This test validates that the hybrid gateway controller correctly
    processes HTTPRoute path matching scenarios including:
    - PathPrefix matching
    - PathExact matching
    - Multiple path matches in a single rule
    - Path matching with strip_path annotation

  timeouts:
    apply: 120s
    assert: 300s
    delete: 120s

  # Define bindings for dynamic resource names
  # TEST_ID comes from CI (github.run_id) or defaults to 'local' for local testing
  bindings:
    - name: test_id
      value: (env('TEST_ID') || 'local')
    - name: gateway_name
      value: (join('-', ['kong', $test_id]))
    - name: proxy_ip
      value: ""

  steps:
    # Step 1: Create prerequisite resources
    - name: create-prerequisites
      description: Create GatewayClass, Gateway, and backend Service
      try:
        - apply:
            file: 01-prerequisites.yaml
        - apply:
            file: 00-httpbin.yaml
        # Assert test-specific resources (namespaces, service, deployment)
        - assert:
            file: 00-assert-httpbin.yaml
        # Assert Gateway resources with dynamic names
        - assert:
            file: 01-assert-gateway.yaml
      catch:
        - description: Get Gateway resource status
          get:
            apiVersion: gateway.networking.k8s.io/v1
            kind: Gateway
            namespace: kong
            format: yaml
        - description: Get DataPlane resources
          get:
            apiVersion: gateway-operator.konghq.com/v1beta1
            kind: DataPlane
            namespace: kong
            format: yaml
        - description: Get ControlPlane resources
          get:
            apiVersion: gateway-operator.konghq.com/v1beta1
            kind: ControlPlane
            namespace: kong
            format: yaml
        - description: Get Pods in kong namespace
          get:
            apiVersion: v1
            kind: Pod
            namespace: kong
            format: yaml
        - description: Describe Gateway
          describe:
            apiVersion: gateway.networking.k8s.io/v1
            kind: Gateway
            namespace: kong
            showEvents: true
        - description: Describe DataPlane
          describe:
            apiVersion: gateway-operator.konghq.com/v1beta1
            kind: DataPlane
            namespace: kong
            showEvents: true
        - description: Get events from kong namespace
          events:
            namespace: kong
        - description: Get operator logs
          podLogs:
            namespace: kong-system
            selector: control-plane=controller-manager
            tail: 100

    # Step 2: Wait for DataPlane pods to be running
    - name: wait-dataplane-pods
      description: Wait for DataPlane proxy pods to be running before traffic tests
      try:
        - description: Wait for DataPlane proxy pods to be running
          script:
            content: |
              echo "=== Waiting for DataPlane proxy pods ==="
              for i in $(seq 1 30); do
                PODS=$(kubectl get pods -n kong -l gateway-operator.konghq.com/managed-by=dataplane -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || true)
                # Fallback to name prefix if labels are missing
                if [ -z "$PODS" ]; then
                  PODS=$(kubectl get pods -n kong -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' 2>/dev/null | grep '^dataplane-' || true)
                fi
                if [ -n "$PODS" ]; then
                  echo "Found DataPlane pods: $PODS"
                  # Wait for at least one pod to be Running
                  RUNNING=$(kubectl get pods -n kong -l gateway-operator.konghq.com/managed-by=dataplane -o jsonpath='{.items[?(@.status.phase=="Running")].metadata.name}' 2>/dev/null || true)
                  if [ -z "$RUNNING" ]; then
                    RUNNING=$(kubectl get pods -n kong -o jsonpath='{range .items[*]}{.metadata.name}{" "}{.status.phase}{"\n"}{end}' 2>/dev/null | awk '/^dataplane-/{if ($2=="Running") print $1}' || true)
                  fi
                  if [ -n "$RUNNING" ]; then
                    echo "DataPlane pod running: $RUNNING"
                    exit 0
                  fi
                  echo "Pods exist but not running yet (attempt $i/30)"
                else
                  echo "No DataPlane pods found yet (attempt $i/30)"
                fi
                # Show current pods for debugging
                kubectl get pods -n kong -o wide 2>/dev/null || true
                sleep 10
              done
              echo "DataPlane pods not ready after 5 minutes"
              kubectl get dataplane -n kong -o yaml
              exit 1
      catch:
        - description: Get DataPlane status
          get:
            apiVersion: gateway-operator.konghq.com/v1beta1
            kind: DataPlane
            namespace: kong
            format: yaml
        - description: Get all pods in kong namespace
          script:
            content: |
              echo "=== All pods in kong namespace ==="
              kubectl get pods -n kong -o wide
        - description: Get operator logs
          podLogs:
            namespace: kong-system
            selector: control-plane=controller-manager
            tail: 100

    # Step 3: Test PathPrefix matching
    - name: test-pathprefix-matching
      description: Create HTTPRoute with PathPrefix matching and verify it works
      try:
        - apply:
            file: 02-pathprefix-httproute.yaml
        - assert:
            file: 02-assert-pathprefix.yaml
        # Get Gateway proxy IP
        - script:
            env:
              - name: GATEWAY_NAME
                value: ($gateway_name)
            content: |
              set -eu
              for i in $(seq 1 30); do
                IP=$(kubectl get gateway ${GATEWAY_NAME} -n kong -o jsonpath='{.status.addresses[0].value}')
                if [ -n "$IP" ]; then
                  echo "$IP"
                  exit 0
                fi
                echo "waiting for gateway address (attempt $i/30)" >&2
                sleep 10
              done
              echo "gateway address not available" >&2
              exit 1
            outputs:
              - name: proxy_ip
                value: ($stdout)
        # Test PathPrefix matching - /httpbin/status/200 should match /httpbin prefix
        - description: Test PathPrefix /httpbin matches /httpbin/status/200
          script:
            env:
              - name: PROXY_IP
                value: ($proxy_ip)
            content: |
              curl --fail --retry 10 --retry-delay 5 --retry-all-errors -s -o /dev/null -w "%{http_code}" http://${PROXY_IP}/httpbin/status/200
            check:
              (contains($stdout, '200')): true
        # Test PathPrefix matching - /httpbin/status/404 should also match /httpbin prefix
        - description: Test PathPrefix /httpbin matches /httpbin/status/404
          script:
            env:
              - name: PROXY_IP
                value: ($proxy_ip)
            content: |
              curl --retry 10 --retry-delay 5 --retry-all-errors -s -o /dev/null -w "%{http_code}" http://${PROXY_IP}/httpbin/status/404
            check:
              (contains($stdout, '404')): true
      catch:
        - description: Get HTTPRoute status
          get:
            apiVersion: gateway.networking.k8s.io/v1
            kind: HTTPRoute
            namespace: kong
            format: yaml
        - description: Get KongRoute status
          get:
            apiVersion: configuration.konghq.com/v1alpha1
            kind: KongRoute
            namespace: kong
            format: yaml
        - description: Get operator logs
          podLogs:
            namespace: kong-system
            selector: control-plane=controller-manager
            tail: 100

    # Step 4: Test PathExact matching
    - name: test-pathexact-matching
      description: Create HTTPRoute with PathExact matching and verify it works
      try:
        - apply:
            file: 03-pathexact-httproute.yaml
        - assert:
            file: 03-assert-pathexact.yaml
        # Get Gateway proxy IP
        - script:
            env:
              - name: GATEWAY_NAME
                value: ($gateway_name)
            content: |
              set -eu
              for i in $(seq 1 30); do
                IP=$(kubectl get gateway ${GATEWAY_NAME} -n kong -o jsonpath='{.status.addresses[0].value}')
                if [ -n "$IP" ]; then
                  echo "$IP"
                  exit 0
                fi
                echo "waiting for gateway address (attempt $i/30)" >&2
                sleep 10
              done
              echo "gateway address not available" >&2
              exit 1
            outputs:
              - name: proxy_ip
                value: ($stdout)
        # Test PathExact matching - /get should match exactly
        - description: Test PathExact /get matches exactly
          script:
            env:
              - name: PROXY_IP
                value: ($proxy_ip)
            content: |
              curl --fail --retry 10 --retry-delay 5 --retry-all-errors -s -o /dev/null -w "%{http_code}" http://${PROXY_IP}/get
            check:
              (contains($stdout, '200')): true
        # Test PathExact matching - /get/subpath should NOT match (404 expected from Kong)
        - description: Test PathExact /get does not match /get/subpath
          script:
            env:
              - name: PROXY_IP
                value: ($proxy_ip)
            content: |
              HTTP_CODE=$(curl --retry 3 --retry-delay 2 -s -o /dev/null -w "%{http_code}" http://${PROXY_IP}/get/subpath)
              # Expect 404 as /get/subpath should not match the exact /get route
              if [ "$HTTP_CODE" = "404" ]; then
                echo "404"
              else
                echo "unexpected: $HTTP_CODE"
              fi
            check:
              (contains($stdout, '404')): true
      catch:
        - description: Get HTTPRoute status
          get:
            apiVersion: gateway.networking.k8s.io/v1
            kind: HTTPRoute
            namespace: kong
            format: yaml
        - description: Get KongRoute status
          get:
            apiVersion: configuration.konghq.com/v1alpha1
            kind: KongRoute
            namespace: kong
            format: yaml
        - description: Get operator logs
          podLogs:
            namespace: kong-system
            selector: control-plane=controller-manager
            tail: 100

    # Step 5: Test multiple path matches in single rule
    - name: test-multiple-paths-matching
      description: Create HTTPRoute with multiple path matches and verify all paths work
      try:
        - apply:
            file: 04-multiple-paths-httproute.yaml
        - assert:
            file: 04-assert-multiple-paths.yaml
        # Get Gateway proxy IP
        - script:
            env:
              - name: GATEWAY_NAME
                value: ($gateway_name)
            content: |
              set -eu
              for i in $(seq 1 30); do
                IP=$(kubectl get gateway ${GATEWAY_NAME} -n kong -o jsonpath='{.status.addresses[0].value}')
                if [ -n "$IP" ]; then
                  echo "$IP"
                  exit 0
                fi
                echo "waiting for gateway address (attempt $i/30)" >&2
                sleep 10
              done
              echo "gateway address not available" >&2
              exit 1
            outputs:
              - name: proxy_ip
                value: ($stdout)
        # Test /headers endpoint (Exact match)
        - description: Test multiple paths - /headers (Exact)
          script:
            env:
              - name: PROXY_IP
                value: ($proxy_ip)
            content: |
              curl --fail --retry 10 --retry-delay 5 --retry-all-errors -s -o /dev/null -w "%{http_code}" http://${PROXY_IP}/headers
            check:
              (contains($stdout, '200')): true
        # Test /ip endpoint (Exact match)
        - description: Test multiple paths - /ip (Exact)
          script:
            env:
              - name: PROXY_IP
                value: ($proxy_ip)
            content: |
              curl --fail --retry 10 --retry-delay 5 --retry-all-errors -s -o /dev/null -w "%{http_code}" http://${PROXY_IP}/ip
            check:
              (contains($stdout, '200')): true
        # Test /anything endpoint (PathPrefix match)
        - description: Test multiple paths - /anything (PathPrefix)
          script:
            env:
              - name: PROXY_IP
                value: ($proxy_ip)
            content: |
              curl --fail --retry 10 --retry-delay 5 --retry-all-errors -s -o /dev/null -w "%{http_code}" http://${PROXY_IP}/anything
            check:
              (contains($stdout, '200')): true
        # Test /anything/subpath endpoint (PathPrefix match)
        - description: Test multiple paths - /anything/subpath (PathPrefix)
          script:
            env:
              - name: PROXY_IP
                value: ($proxy_ip)
            content: |
              curl --fail --retry 10 --retry-delay 5 --retry-all-errors -s -o /dev/null -w "%{http_code}" http://${PROXY_IP}/anything/subpath
            check:
              (contains($stdout, '200')): true
      catch:
        - description: Get HTTPRoute status
          get:
            apiVersion: gateway.networking.k8s.io/v1
            kind: HTTPRoute
            namespace: kong
            format: yaml
        - description: Get KongRoute status
          get:
            apiVersion: configuration.konghq.com/v1alpha1
            kind: KongRoute
            namespace: kong
            format: yaml
        - description: Get operator logs
          podLogs:
            namespace: kong-system
            selector: control-plane=controller-manager
            tail: 100

    # Step 6: Test strip_path annotation
    - name: test-strip-path-annotation
      description: Create HTTPRoute with strip_path annotation and verify path handling
      try:
        - apply:
            file: 05-strip-path-httproute.yaml
        - assert:
            file: 05-assert-strip-path.yaml
        # Verify KongRoute has strip_path set to false
        - assert:
            resource:
              apiVersion: configuration.konghq.com/v1alpha1
              kind: KongRoute
              metadata:
                namespace: kong
                (labels."gateway-operator.konghq.com/managed-by" == 'HTTPRoute'): true
                (annotations."gateway-operator.konghq.com/hybrid-routes" | contains(@, 'kong/strip-path-route')): true
              spec:
                strip_path: false
        # Get Gateway proxy IP
        - script:
            env:
              - name: GATEWAY_NAME
                value: ($gateway_name)
            content: |
              set -eu
              for i in $(seq 1 30); do
                IP=$(kubectl get gateway ${GATEWAY_NAME} -n kong -o jsonpath='{.status.addresses[0].value}')
                if [ -n "$IP" ]; then
                  echo "$IP"
                  exit 0
                fi
                echo "waiting for gateway address (attempt $i/30)" >&2
                sleep 10
              done
              echo "gateway address not available" >&2
              exit 1
            outputs:
              - name: proxy_ip
                value: ($stdout)
        # Test strip_path=false - the /api prefix should be preserved and forwarded to httpbin
        # httpbin will see the full path /api/anything and respond accordingly
        - description: Test strip_path=false preserves path prefix
          script:
            env:
              - name: PROXY_IP
                value: ($proxy_ip)
            content: |
              # Request /api/anything - httpbin will see /api/anything due to strip_path=false
              RESPONSE=$(curl --fail --retry 10 --retry-delay 5 --retry-all-errors -s http://${PROXY_IP}/api/anything)
              # Verify the response contains the full path (httpbin's /anything endpoint returns the URL in response)
              if echo "$RESPONSE" | grep -q '"/api/anything"'; then
                echo "200"
              else
                echo "path not preserved in response: $RESPONSE"
              fi
            check:
              (contains($stdout, '200')): true
      catch:
        - description: Get HTTPRoute status
          get:
            apiVersion: gateway.networking.k8s.io/v1
            kind: HTTPRoute
            namespace: kong
            format: yaml
        - description: Get KongRoute status
          get:
            apiVersion: configuration.konghq.com/v1alpha1
            kind: KongRoute
            namespace: kong
            format: yaml
        - description: Get operator logs
          podLogs:
            namespace: kong-system
            selector: control-plane=controller-manager
            tail: 100

    # Step 7: Cleanup - delete all HTTPRoutes
    - name: cleanup-httproutes
      description: Clean up all test HTTPRoutes
      try:
        - delete:
            ref:
              apiVersion: gateway.networking.k8s.io/v1
              kind: HTTPRoute
              name: pathprefix-route
              namespace: kong
        - delete:
            ref:
              apiVersion: gateway.networking.k8s.io/v1
              kind: HTTPRoute
              name: pathexact-route
              namespace: kong
        - delete:
            ref:
              apiVersion: gateway.networking.k8s.io/v1
              kind: HTTPRoute
              name: multiple-paths-route
              namespace: kong
        - delete:
            ref:
              apiVersion: gateway.networking.k8s.io/v1
              kind: HTTPRoute
              name: strip-path-route
              namespace: kong
