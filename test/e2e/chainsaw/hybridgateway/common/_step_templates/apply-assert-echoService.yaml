# Template for creating and asserting an echo service.
#
# Required bindings:
#   - test_name: Test name used to compose the service name.
#   - echo_service_namespace: Namespace where the service will be created.
#   - echo_deployment_namespace: Namespace where the deployment will be created.
# Optional bindings:
#   - echo_service_name: Override for Service/Deployment name (and app label/selector).
#                        Default: join('-', [($test_name), 'echo'])
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: StepTemplate
metadata:
  name: create-echo-service
spec:
  # Default bindings - can be overridden by the caller
  bindings:
    - name: echo_service_name
      value: (join('-', [($test_name), 'echo']))
  try:
    # 1. Apply the Service.
    - apply:
        resource:
          apiVersion: v1
          kind: Service
          metadata:
            labels:
              app: ($echo_service_name)
            name: ($echo_service_name)
            namespace: ($echo_service_namespace)
          spec:
            ports:
              - port: 1025
                name: tcp
                protocol: TCP
                targetPort: 1025
              - port: 1026
                name: udp
                protocol: TCP
                targetPort: 1026
              - port: 1027
                name: http
                protocol: TCP
                targetPort: 1027
              - port: 1030
                name: tls
                protocol: TCP
                targetPort: 1030
            selector:
              app: ($echo_service_name)

    # 2. Apply the Deployment.
    - apply:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            labels:
              app: ($echo_service_name)
            name: ($echo_service_name)
            namespace: ($echo_deployment_namespace)
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: ($echo_service_name)
            template:
              metadata:
                labels:
                  app: ($echo_service_name)
              spec:
                containers:
                  - image: kong/go-echo:latest
                    name: echo
                    ports:
                      - containerPort: 1025
                      - containerPort: 1026
                      - containerPort: 1027
                      - containerPort: 1030
                    env:
                      - name: NODE_NAME
                        valueFrom:
                          fieldRef:
                            fieldPath: spec.nodeName
                      - name: POD_NAME
                        valueFrom:
                          fieldRef:
                            fieldPath: metadata.name
                      - name: POD_NAMESPACE
                        valueFrom:
                          fieldRef:
                            fieldPath: metadata.namespace
                      - name: POD_IP
                        valueFrom:
                          fieldRef:
                            fieldPath: status.podIP
                    readinessProbe:
                      httpGet:
                        path: /
                        port: 1027
                      initialDelaySeconds: 5
                      periodSeconds: 5
                    resources:
                      requests:
                        cpu: 100m
                        memory: 128Mi
                      limits:
                        cpu: 210m
                        memory: 256Mi

    # 3. Assert Deployment Readiness.
    - assert:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ($echo_service_name)
            namespace: ($echo_deployment_namespace)
          status:
            availableReplicas: 1
            readyReplicas: 1

    # 4. Assert Service existence and configuration.
    - assert:
        resource:
          apiVersion: v1
          kind: Service
          metadata:
            name: ($echo_service_name)
            namespace: ($echo_service_namespace)
          spec:
            selector:
              app: ($echo_service_name)
