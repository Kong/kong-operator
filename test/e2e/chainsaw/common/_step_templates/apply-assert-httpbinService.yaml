# Template for creating and asserting an httpbin service.
#
# Required bindings:
#   - test_name: Test name used to compose the service name.
#   - namespace: Namespace where the service will be created.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: StepTemplate
metadata:
  name: create-httpbin-service
spec:
  try:
    # 1. Apply the Deployment.
    - apply:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ($httpbin_deployment_name)
            namespace: ($httpbin_deployment_namespace)
            labels:
              app: ($httpbin_deployment_name)
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: ($httpbin_deployment_name)
            template:
              metadata:
                labels:
                  app: ($httpbin_deployment_name)
              spec:
                containers:
                  - name: httpbin
                    image: ghcr.io/mccutchen/go-httpbin:2.19
                    ports:
                      - name: http
                        containerPort: 8080
                        protocol: TCP
                    livenessProbe:
                      httpGet:
                        path: /status/200
                        port: http
                    readinessProbe:
                      httpGet:
                        path: /status/200
                        port: http
                    resources:
                      requests:
                        cpu: 50m
                        memory: 64Mi
                      limits:
                        cpu: 100m
                        memory: 128Mi
                    securityContext:
                      runAsNonRoot: true

    # 2. Apply the Service.
    - apply:
        resource:
          apiVersion: v1
          kind: Service
          metadata:
            name: ($httpbin_deployment_name)
            namespace: ($httpbin_deployment_namespace)
            labels:
              app: ($httpbin_deployment_name)
          spec:
            selector:
              app: ($httpbin_deployment_name)
            ports:
              - port: 80
                targetPort: http
                protocol: TCP
                name: http
                appProtocol: http

    # 3. Assert Deployment Readiness.
    - assert:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ($httpbin_deployment_name)
            namespace: ($httpbin_deployment_namespace)
          status:
            (conditions[?type == 'Available']):
              - status: 'True'
            readyReplicas: 1
            replicas: 1

    # 4. Assert Service existence and configuration.
    - assert:
        resource:
          apiVersion: v1
          kind: Service
          metadata:
            name: ($httpbin_deployment_name)
            namespace: ($httpbin_deployment_namespace)
          spec:
            selector:
              app: ($httpbin_deployment_name)
