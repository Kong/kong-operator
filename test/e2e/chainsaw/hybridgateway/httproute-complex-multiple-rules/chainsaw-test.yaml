# HTTPRoute Complex Multiple Rules test scenario.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: httproute-complex-multiple-rules
spec:
  description: |
    This test validates complex HTTPRoute scenarios that combine multiple matching types:
    - Path matching (Exact and PathPrefix).
    - Header matching (Exact and RegularExpression).
    - Method matching (GET, POST, PUT, PATCH, DELETE).
    - Multiple rules with different matching criteria in a single HTTPRoute.
    - Complex routing logic verification.

  bindings:
    - name: test_name
      value: ($namespace)
    - name: namespace
      value: ($namespace)
    - name: konnect_api_auth_name
      value: konnect-api-auth-dev-1
    - name: konnect_token
      value: (env('KONNECT_TOKEN'))
    - name: konnect_url
      value: (env('KONNECT_SERVER_URL') || 'eu.api.konghq.tech')
    - name: gateway_image
      value: (env('GATEWAY_IMAGE') || 'kong/kong-gateway:3.12')
    - name: gateway_class_name
      value: (join('-', [($test_name), 'gateway-class']))
    - name: gateway_configuration_name
      value: (join('-', [($test_name), 'gateway-configuration']))
    - name: gateway_namespace
      value: ($namespace)
    - name: gateway_name
      value: (join('-', [($namespace), 'gateway']))
    - name: http_route_namespace
      value: ($namespace)
    - name: httproute_name
      value: complex-multiple-rules
    - name: http_route_name
      value: ($httproute_name)
    - name: listener_http_port
      value: "80"
    - name: host_header
      value: ""
    - name: request_headers
      value: ""

    # Backend service bindings.
    - name: httpbin_deployment_name
      value: httpbin
    - name: httpbin_deployment_namespace
      value: ($namespace)

  steps:
  # Step 1: Create KonnectAPIAuthConfiguration.
  - name: 1-create-konnect-api-auth
    description: Create KonnectAPIAuthConfiguration for the test.
    use:
      template: ../../common/_step_templates/apply-assert-konnectAPIAuthConfiguration.yaml

  # Step 2: Create GatewayConfiguration.
  - name: 2-create-gateway-configuration
    description: Create GatewayConfiguration for the test.
    use:
      template: ../../common/_step_templates/apply-assert-gatewayConfiguration.yaml

  # Step 3: Create GatewayClass.
  - name: 3-create-gateway-class
    description: Create GatewayClass for the test.
    use:
      template: ../../common/_step_templates/apply-assert-gatewayClass.yaml

  # Step 4: Create Gateway.
  - name: 4-create-gateway
    description: Create Gateway for the test.
    use:
      template: ../../common/_step_templates/apply-assert-gateway-http-only.yaml

  # Step 5: Create httpbin backend service.
  - name: 5-create-httpbin
    description: Create httpbin deployment and service.
    use:
      template: ../../common/_step_templates/apply-assert-httpbinService.yaml

  # Step 6: Create complex HTTPRoute with multiple rules.
  - name: 6-create-complex-httproute
    description: Create HTTPRoute with multiple rules combining path, header, and method matching.
    try:
      - apply:
          file: 01-httproute-complex.yaml
      - assert:
          file: 01-assert-httproute-complex.yaml

  # Step 7: Test Rule 1 - GET /get with X-Api-Version header.
  # Test positive case: GET /get with X-Api-Version:v1 returns 200.
  - name: 7a-test-rule1-get-with-header-success
    description: Test GET /get with X-Api-Version:v1 returns 200.
    bindings:
      - name: http_method
        value: GET
      - name: route_path
        value: /get
      - name: request_headers
        value: "X-Api-Version:v1"
      - name: expected_status
        value: "200"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Test negative case: GET /get without header returns 404.
  - name: 7b-test-rule1-get-without-header-fail
    description: Test GET /get without header returns 404.
    bindings:
      - name: http_method
        value: GET
      - name: route_path
        value: /get
      - name: request_headers
        value: ""
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Test negative case: GET /get with wrong header value returns 404.
  - name: 7c-test-rule1-get-wrong-header-fail
    description: Test GET /get with X-Api-Version:v2 returns 404.
    bindings:
      - name: http_method
        value: GET
      - name: route_path
        value: /get
      - name: request_headers
        value: "X-Api-Version:v2"
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Test negative case: POST /get with correct header returns 404 (route requires GET method).
  - name: 7d-test-rule1-post-wrong-method-fail
    description: Test POST /get with X-Api-Version:v1 returns 404.
    bindings:
      - name: http_method
        value: POST
      - name: route_path
        value: /get
      - name: request_headers
        value: "X-Api-Version:v1"
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Step 8: Test Rule 2 - POST /post (no header requirement).
  # Test positive case: POST /post returns 200.
  - name: 8a-test-rule2-post-success
    description: Test POST /post returns 200.
    bindings:
      - name: http_method
        value: POST
      - name: route_path
        value: /post
      - name: expected_status
        value: "200"
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml

  # Test negative case: GET /post returns 404 (route requires POST method).
  - name: 8b-test-rule2-get-wrong-method-fail
    description: Test GET /post returns 404.
    bindings:
      - name: http_method
        value: GET
      - name: route_path
        value: /post
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml

  # Step 9: Test Rule 3 - /headers prefix with X-Custom-Header.
  # Test positive case: GET /headers with X-Custom-Header:enabled returns 200.
  - name: 9a-test-rule3-headers-with-header-success
    description: Test GET /headers with X-Custom-Header:enabled returns 200.
    bindings:
      - name: http_method
        value: GET
      - name: route_path
        value: /headers
      - name: request_headers
        value: "X-Custom-Header:enabled"
      - name: expected_status
        value: "200"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Test positive case: POST /headers with X-Custom-Header:enabled returns 200.
  - name: 9b-test-rule3-post-headers-with-header-success
    description: Test POST /headers with X-Custom-Header:enabled returns 200.
    bindings:
      - name: http_method
        value: POST
      - name: route_path
        value: /headers
      - name: request_headers
        value: "X-Custom-Header:enabled"
      - name: expected_status
        value: "200"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Test negative case: GET /headers without header returns 404.
  - name: 9c-test-rule3-headers-without-header-fail
    description: Test GET /headers without header returns 404.
    bindings:
      - name: http_method
        value: GET
      - name: route_path
        value: /headers
      - name: request_headers
        value: ""
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Test negative case: GET /headers with wrong header value returns 404.
  - name: 9d-test-rule3-headers-wrong-header-fail
    description: Test GET /headers with X-Custom-Header:disabled returns 404.
    bindings:
      - name: http_method
        value: GET
      - name: route_path
        value: /headers
      - name: request_headers
        value: "X-Custom-Header:disabled"
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Step 10: Test Rule 4 - PUT or PATCH /anything.
  # Test positive case: PUT /anything returns 200.
  - name: 10a-test-rule4-put-success
    description: Test PUT /anything returns 200.
    bindings:
      - name: http_method
        value: PUT
      - name: route_path
        value: /anything
      - name: expected_status
        value: "200"
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml

  # Test positive case: PATCH /anything returns 200.
  - name: 10b-test-rule4-patch-success
    description: Test PATCH /anything returns 200.
    bindings:
      - name: http_method
        value: PATCH
      - name: route_path
        value: /anything
      - name: expected_status
        value: "200"
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml

  # Test positive case: PUT /anything/subpath returns 200 (PathPrefix).
  - name: 10c-test-rule4-put-subpath-success
    description: Test PUT /anything/subpath returns 200.
    bindings:
      - name: http_method
        value: PUT
      - name: route_path
        value: /anything/subpath
      - name: expected_status
        value: "200"
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml

  # Test negative case: GET /anything returns 404 (only PUT/PATCH allowed).
  - name: 10d-test-rule4-get-wrong-method-fail
    description: Test GET /anything returns 404.
    bindings:
      - name: http_method
        value: GET
      - name: route_path
        value: /anything
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml

  # Test negative case: DELETE /anything returns 404 (only PUT/PATCH allowed).
  - name: 10e-test-rule4-delete-wrong-method-fail
    description: Test DELETE /anything returns 404.
    bindings:
      - name: http_method
        value: DELETE
      - name: route_path
        value: /anything
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml

  # Step 11: Test Rule 5 - DELETE /delete with regex header.
  # Test positive case: DELETE /delete with valid token returns 200.
  - name: 11a-test-rule5-delete-with-token-success
    description: Test DELETE /delete with X-Delete-Token:token-abc123 returns 200.
    bindings:
      - name: http_method
        value: DELETE
      - name: route_path
        value: /delete
      - name: request_headers
        value: "X-Delete-Token:token-abc123"
      - name: expected_status
        value: "200"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Test positive case: DELETE /delete with another valid token returns 200.
  - name: 11b-test-rule5-delete-with-another-token-success
    description: Test DELETE /delete with X-Delete-Token:token-xyz789 returns 200.
    bindings:
      - name: http_method
        value: DELETE
      - name: route_path
        value: /delete
      - name: request_headers
        value: "X-Delete-Token:token-xyz789"
      - name: expected_status
        value: "200"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Test negative case: DELETE /delete without header returns 404.
  - name: 11c-test-rule5-delete-without-header-fail
    description: Test DELETE /delete without header returns 404.
    bindings:
      - name: http_method
        value: DELETE
      - name: route_path
        value: /delete
      - name: request_headers
        value: ""
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Test negative case: DELETE /delete with invalid token returns 404.
  - name: 11d-test-rule5-delete-invalid-token-fail
    description: Test DELETE /delete with X-Delete-Token:invalid returns 404.
    bindings:
      - name: http_method
        value: DELETE
      - name: route_path
        value: /delete
      - name: request_headers
        value: "X-Delete-Token:invalid"
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Test negative case: DELETE /delete with token not starting with 'token-' returns 404.
  - name: 11e-test-rule5-delete-wrong-prefix-fail
    description: Test DELETE /delete with X-Delete-Token:notvalid-abc123 returns 404.
    bindings:
      - name: http_method
        value: DELETE
      - name: route_path
        value: /delete
      - name: request_headers
        value: "X-Delete-Token:notvalid-abc123"
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  # Test negative case: GET /delete with valid token returns 404 (wrong method).
  - name: 11f-test-rule5-get-wrong-method-fail
    description: Test GET /delete with valid token returns 404.
    bindings:
      - name: http_method
        value: GET
      - name: route_path
        value: /delete
      - name: request_headers
        value: "X-Delete-Token:token-abc123"
      - name: expected_status
        value: "404"
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml

  catch:
    # Capture debug snapshot on test failure for CI debugging.
    - description: Capture debug snapshot
      script:
        env:
          - name: TEST_NAME
            value: hybridgateway-httproute-complex-multiple-rules
          - name: NAMESPACE
            value: ($namespace)
          - name: OPERATOR_NAMESPACE
            value: kong-system
        content: |
          bash ../../common/scripts/debug_snapshot.sh
