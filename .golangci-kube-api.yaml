version: "2"
linters:
  default: none
  enable:
    - kubeapilinter
  settings:
    custom:
      kubeapilinter:
        type: module
        description: Kube API LInter lints Kube like APIs based on API conventions and best practices.
        settings:
          linters:
            disable:
              - "*"
            enable:
              - arrayofstruct
              - conditions
              - defaultorrequired
              - duplicatemarkers
              - integers
              - jsontags
              - maxlength
              - nobools
              - nodurations
              - nofloats
              - nomaps
              - nonullable
              - nophase
              - notimestamp
              - optionalorrequired
              - preferredmarkers
              - requiredfields
              - statusoptional
              - statussubresource
              - uniquemarkers
          lintersConfig:
            # https://github.com/kubernetes-sigs/kube-api-linter/issues/195
            # requiredfields:
            #   omitempty:
            #     policy: Ignore
            preferredmarkers:
              markers:
                - preferredIdentifier: "k8s:optional"
                  equivalentIdentifiers:
                    - identifier: "kubebuilder:validation:Optional"
                - preferredIdentifier: "k8s:required"
                  equivalentIdentifiers:
                    - identifier: "kubebuilder:validation:Required"
            conditions:
              isFirstField: Warn
              useProtobuf: Warn
              usePatchStrategy: Warn
            nomaps:
              policy: AllowStringToStringMaps
            # We allow underscores as that's what many Konnect related fields use.
            jsonTags:
              jsonTagRegex: "^[a-z][a-z0-9_]*(?:[A-Z][a-z0-9_]*)*$"
            optionalOrRequired:
              preferredOptionalMarker: optional
              preferredRequiredMarker: required
  exclusions:
    rules:
      - linters:
          - kubeapilinter
        path: .*
        text: "(optionalorrequired: embedded field .*.metav1.ObjectMeta must be marked as optional or required)"
      # NOTE: kubeapilinter has been introduced after v1alpha1/konnect_gateway_controlplane_types.go
      #       has been created and to prevent changes in the API and docs we disable the rule.
      - linters:
          - kubeapilinter
        path: api/konnect/v1alpha1/konnect_gateway_controlplane_types.go
        text: "nobools: field CloudGateway pointer should not use a bool. Use a string type with meaningful constant values as an enum."
      # NOTE: Let the old APIs be as they are.
      - linters:
          - kubeapilinter
        path: api/konnect/v1alpha1/.*
        text: "conditions: Conditions field is missing the following markers: patchStrategy=merge, patchMergeKey=type"
      # NOTE: Let the old APIs be as they are.
      - linters:
          - kubeapilinter
        path: api/konnect/v1alpha1/.*
        text: "conditions: Conditions field has incorrect tags, should be:"
      # NOTE: Let the old APIs be as they are.
      - linters:
          - kubeapilinter
        path: api/konnect/v1alpha1/.*
        text: "conditions: Conditions field must be the first field in the struct"
      # NOTE: We've already released v2beta1 with Duration fields in ControlPlane spec.
      - linters:
          - kubeapilinter
        path: api/gateway-operator/v2beta1/controlplane_types.go
        text: 'nodurations: field ControlPlane.* pointer should not use a Duration'

      # TODO: remove this.
      - linters:
          - kubeapilinter
        path: api/(konnect|gateway-operator).*
        text: "requiredfields: field .* should have the omitempty tag."

      # TODO: remove this.
      - linters:
          - kubeapilinter
        path: api/konnect/.*
        text: "requiredfields: field .* does not allow the zero value. It must have the omitzero tag."

      # TODO: remove this.
      - linters:
          - kubeapilinter
        path: api/konnect/(v1alpha1|v1alpha2)/.*
        text: 'requiredfields: field .* has a valid zero value .* but the validation is not complete'

      # TODO: remove this.
      - linters:
          - kubeapilinter
        path: api/gateway-operator/v2beta1/shared_types.go
        text: 'requiredfields: field .* has a valid zero value .* but the validation is not complete'

      # TODO: remove this.
      - linters:
          - kubeapilinter
        path: api/gateway-operator/v2beta1/shared_types.go
        text: 'requiredfields: field Strategy has a valid zero value .* and should be a pointer.'

      # TODO: remove this.
      - linters:
          - kubeapilinter
        path: api/(konnect/v1alpha(1|2)|gateway-operator/v2beta1)/.*
        text: 'maxlength: .*'
