# HTTPRoute header match test scenario.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: httproute-header-match
spec:
  description: |
    This test validates that the hybrid gateway controller correctly
    processes a basic HTTPRoute with matches on headers and generates
    routes that direct traffics as expected.

  bindings:
    - name: test_name
      value: ($namespace)
    - name: namespace
      value: ($namespace)
    - name: konnect_api_auth_name
      value: konnect-api-auth-dev-1
    - name: konnect_api_auth_namespace
      value: ($namespace)
    - name: konnect_token
      value: (env('KONNECT_TOKEN'))
    - name: konnect_url
      value: (env('KONNECT_SERVER_URL') || 'eu.api.konghq.tech')
    - name: auth_secret_name
      value: (join('-', [($test_name), 'konnect-auth-secret']))
    - name: auth_secret_namespace
      value: ($namespace)
    - name: konnect_auth_name
      value: (join('-', [($test_name), 'konnect-api-auth']))
    - name: konnect_auth_namespace
      value: ($namespace)
    - name: gateway_class_name
      value: (join('-', [($test_name), 'gateway-class']))
    - name: gateway_configuration_name
      value: (join('-', [($test_name), 'gateway-configuration']))
    - name: gateway_name
      value: (join('-', [($test_name), 'gateway']))
    - name: gateway_namespace
      value: ($namespace)
    - name: gateway_image
      value: (env('GATEWAY_IMAGE') || 'kong/kong-gateway:3.12')
    - name: http_route_name
      value: echo-header-match
    - name: http_route_namespace
      value: ($namespace)
    - name: echo_deployment_name
      value: echo
    - name: echo_deployment_namespace
      value: ($namespace)
    - name: http_method
      value: "GET"
    - name: host_header
      value: ""
    - name: listener_http_port
      value: 80

  steps:
  # Step 1: Create test namespace.
  - name: create-namespace
    description: Create namespace for test resources
    use:
      template: ../../common/_step_templates/apply-assert-namespace.yaml
    bindings:
      - name: namespace_name
        value: ($namespace)

  # Step 2a: Create the secret for Konnect authentication.
  - name: Create-auth-secret
    description: Create Secret with Konnect token for KonnectAPIAuthConfiguration.
    use:
      template: ../../common/_step_templates/apply-assert-konnectAuthSecret.yaml

  # Step 2b: Create KonnectAPIAuthConfiguration.
  - name: create-konnect-api-auth
    description: Create KonnectAPIAuthConfiguration for the test
    use:
      template: ../../common/_step_templates/apply-assert-konnectAPIAuthConfiguration-secretref.yaml

  # Step 3: Create GatewayConfiguration.
  - name: create-gateway-configuration
    description: Create GatewayConfiguration for the test
    use:
      template: ../../common/_step_templates/apply-assert-gatewayConfiguration.yaml

  # Step 4: Create GatewayClass.
  - name: create-gateway-class
    description: Create GatewayClass for the test
    use:
      template: ../../common/_step_templates/apply-assert-gatewayClass.yaml

  # Step 5: Create Gateway (HTTP-only, no TLS).
  - name: create-gateway
    description: Create Gateway with HTTP listener
    use:
      template: ../../common/_step_templates/apply-assert-gateway-http-only.yaml

  # Step 6: Create echo service.
  - name: create-echo-service
    description: Create and assert an echo service to route traffic to
    use:
      template: ../../common/_step_templates/apply-assert-echoService.yaml

  # Step 7: Create an HTTPRoute that matches a single header and verify the routes are correctly configured.
  - name: create-httproute-single-header-match
    description: Create an HTTPRoute that matches a single header
    try:
      - apply:
          file: 01-httproute-single-header-match.yaml
      # Assert status of HTTPRoute.
      - assert:
          file: 01-assert-httproute-single-header-match.yaml

  # Step 8: Verify routing with matching header.
  - name: verify-single-header-match-with-matching-header
    description: Verify routing works with matching header value
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: route_path
        value: "/"
      - name: request_headers
        value: "single-header-1:v1"
      - name: expected_status
        value: "200"

  # Step 9: Verify routing without header returns 404.
  - name: verify-single-header-match-without-header
    description: Verify routing returns 404 when required header is missing
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: route_path
        value: "/"
      - name: request_headers
        value: ""
      - name: expected_status
        value: "404"

  # Step 10: Verify routing with wrong header value returns 404.
  - name: verify-single-header-match-with-wrong-value
    description: Verify routing returns 404 when header has unmatched value
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: route_path
        value: "/"
      - name: request_headers
        value: "single-header-1:v2"
      - name: expected_status
        value: "404"

  # Step 11: Update the HTTPRoute to match multiple headers.
  - name: update-httproute-multiple-header-match
    description: Get current Kong resources, update the HTTPRoute to match multiple headers (ANDed), and verify old resources are deleted.
    try:
      - script:
          env:
            - name: NAMESPACE
              value: ($namespace)
            - name: GATEWAY_NAME
              value: ($gateway_name)
            - name: GATEWAY_NAMESPACE
              value: ($gateway_namespace)
            - name: HTTP_ROUTE_NAME
              value: ($http_route_name)
            - name: HTTP_ROUTE_NAMESPACE
              value: ($http_route_namespace)
            - name: RESOURCE_TYPES
              value: "kongroutes.configuration.konghq.com"
          content: |
            bash ../../common/scripts/get_kong_resources.sh
          outputs:
            - name: old_resources
              value: (json_parse($stdout))
      - apply:
          file: 02-update-httproute-multiple-header-match.yaml
      - script:
          env:
            - name: RESOURCES_JSON
              value: (to_string($old_resources))
          content: |
            bash ../../common/scripts/wait_for_kong_resources_deletion.sh
      - assert:
          file: 02-assert-update-httproute-multiple-header-match.yaml

  # Step 12: Verify routing with both matching headers.
  - name: verify-multiple-header-match-with-both-matching
    description: Verify routing works when both headers match
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: route_path
        value: "/"
      - name: request_headers
        value: "multiple-header-1:v1,multiple-header-2:v2"
      - name: expected_status
        value: "200"

  # Step 13: Verify routing with one matching header returns 404.
  - name: verify-multiple-header-match-with-one-matching-first
    description: Verify routing returns 404 when only first header matches
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: route_path
        value: "/"
      - name: request_headers
        value: "multiple-header-1:v1,multiple-header-2:v1"
      - name: expected_status
        value: "404"

  # Step 14: Verify routing with one matching header returns 404 (second scenario).
  - name: verify-multiple-header-match-with-one-matching-second
    description: Verify routing returns 404 when only second header matches
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: route_path
        value: "/"
      - name: request_headers
        value: "multiple-header-1:v2,multiple-header-2:v2"
      - name: expected_status
        value: "404"

  # Step 15: Update the HTTPRoute to regex header matching.
  - name: update-httproute-regex-header-match
    description: Get current Kong resources, update the HTTPRoute to match headers by regular expressions, and verify old resources are deleted.
    try:
      - script:
          env:
            - name: NAMESPACE
              value: ($namespace)
            - name: GATEWAY_NAME
              value: ($gateway_name)
            - name: GATEWAY_NAMESPACE
              value: ($gateway_namespace)
            - name: HTTP_ROUTE_NAME
              value: ($http_route_name)
            - name: HTTP_ROUTE_NAMESPACE
              value: ($http_route_namespace)
            - name: RESOURCE_TYPES
              value: "kongroutes.configuration.konghq.com"
          content: |
            bash ../../common/scripts/get_kong_resources.sh
          outputs:
            - name: old_resources
              value: (json_parse($stdout))
      - apply:
          file: 03-update-httproute-regex-header-match.yaml
      - script:
          env:
            - name: RESOURCES_JSON
              value: (to_string($old_resources))
          content: |
            bash ../../common/scripts/wait_for_kong_resources_deletion.sh
      - assert:
          file: 03-assert-update-httproute-regex-header-match.yaml

  # Step 16: Verify routing with regex matching header.
  - name: verify-regex-header-match-with-matching-value
    description: Verify routing works when header value matches regex
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: route_path
        value: "/"
      - name: request_headers
        value: "regex-header-1:abc"
      - name: expected_status
        value: "200"

  # Step 17: Verify routing with non-matching regex value returns 404.
  - name: verify-regex-header-match-with-non-matching-value
    description: Verify routing returns 404 when header value does not match regex
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: route_path
        value: "/"
      - name: request_headers
        value: "regex-header-1:123"
      - name: expected_status
        value: "404"

  catch:
    # Capture debug snapshot on test failure for CI debugging.
    - description: Capture debug snapshot
      script:
        env:
          - name: TEST_NAME
            value: hybridgateway-httproute-header-match
          - name: NAMESPACE
            value: ($namespace)
          - name: OPERATOR_NAMESPACE
            value: kong-system
        content: |
          bash ../../common/scripts/debug_snapshot.sh
