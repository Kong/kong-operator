# Template for generating and creating a TLS secret.
#
# Required bindings:
#   - sni_hostname: SNI hostname for the certificate (e.g., "*.example.com").
#   - cert_secret_name: Name of the TLS secret to create.
#   - cert_secret_namespace: Namespace where the TLS secret will be created.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: StepTemplate
metadata:
  name: assert-tls-secret
spec:
  try:
    - script:
        env:
         - name: HOSTNAME
           value: ($sni_hostname)
        content: |
          bash ../../common/scripts/generate_tls_certificate.sh
        outputs:
          # Output 1: Extract 'cert' from the JSON stdout.
          - name: cert_data
            value: (json_parse($stdout).cert)
          # Output 2: Extract 'key' from the same JSON stdout.
          - name: key_data
            value: (json_parse($stdout).key)
    - apply:
        resource:
          apiVersion: v1
          kind: Secret
          metadata:
            name: ($cert_secret_name)
            namespace: ($cert_secret_namespace)
            labels:
              konghq.com/secret: "true"
          type: kubernetes.io/tls
          stringData:
            tls.crt: ($cert_data)
            tls.key: ($key_data)
    - assert:
        resource:
          apiVersion: v1
          kind: Secret
          metadata:
            name: ($cert_secret_name)
            namespace: ($cert_secret_namespace)
            labels:
              konghq.com/secret: "true"
          type: kubernetes.io/tls
