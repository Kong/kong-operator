# HTTPRoute Method Matching test scenario.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: httproute-method-matching
spec:
  description: |
    This test validates HTTPRoute method matching scenarios including:
    - Single HTTP method (GET, POST, PUT, DELETE, PATCH)
    - Multiple HTTP methods in single rule
    - Method matching combined with path matching

  bindings:
    - name: test_name
      value: ($namespace)
    - name: namespace
      value: ($namespace)
    - name: konnect_api_auth_name
      value: konnect-api-auth-dev-1
    - name: konnect_api_auth_namespace
      value: ($namespace)
    - name: konnect_token
      value: (env('KONNECT_TOKEN'))
    - name: konnect_url
      value: (env('KONNECT_SERVER_URL') || 'eu.api.konghq.tech')
    - name: auth_secret_name
      value: (join('-', [($test_name), 'konnect-auth-secret']))
    - name: auth_secret_namespace
      value: ($namespace)
    - name: konnect_auth_name
      value: (join('-', [($test_name), 'konnect-api-auth']))
    - name: konnect_auth_namespace
      value: ($namespace)
    - name: gateway_class_name
      value: (join('-', [($test_name), 'gateway-class']))
    - name: gateway_configuration_name
      value: (join('-', [($test_name), 'gateway-configuration']))
    - name: gateway_name
      value: (join('-', [($test_name), 'gateway']))
    - name: gateway_namespace
      value: ($namespace)
    - name: gateway_image
      value: (env('GATEWAY_IMAGE') || 'kong/kong-gateway:3.12')
    - name: httproute_name_get
      value: method-matching-get
    - name: httproute_name_post
      value: method-matching-post
    - name: httproute_name_put
      value: method-matching-put
    - name: httproute_name_delete
      value: method-matching-delete
    - name: httproute_name_patch
      value: method-matching-patch
    - name: httproute_name_multiple
      value: method-matching-multiple
    - name: httproute_name_combined
      value: method-matching-combined
    - name: httproute_name_update_test
      value: method-matching-update-test
    - name: http_route_namespace
      value: ($namespace)
    - name: httpbin_deployment_name
      value: httpbin
    - name: httpbin_deployment_namespace
      value: ($namespace)
    - name: httpbin_service_port
      value: 80
    - name: listener_http_port
      value: 80
    - name: http_method
      value: "GET"
    - name: host_header
      value: ""

  steps:
  # Step 2a: Create the secret for Konnect authentication.
  - name: Create-auth-secret
    description: Create Secret with Konnect token for KonnectAPIAuthConfiguration.
    use:
      template: ../../common/_step_templates/apply-assert-konnectAuthSecret.yaml

  # Step 2b: Create KonnectAPIAuthConfiguration.
  - name: create-konnect-api-auth
    description: Create KonnectAPIAuthConfiguration for the test
    use:
      template: ../../common/_step_templates/apply-assert-konnectAPIAuthConfiguration-secretref.yaml

  # Step 3: Create GatewayConfiguration.
  - name: create-gateway-configuration
    description: Create GatewayConfiguration for the test
    use:
      template: ../../common/_step_templates/apply-assert-gatewayConfiguration.yaml

  # Step 4: Create GatewayClass.
  - name: create-gateway-class
    description: Create GatewayClass for the test
    use:
      template: ../../common/_step_templates/apply-assert-gatewayClass.yaml

  # Step 5: Create Gateway (HTTP-only, no TLS).
  - name: create-gateway
    description: Create Gateway with HTTP listener
    use:
      template: ../../common/_step_templates/apply-assert-gateway-http-only.yaml

  # Step 6: Create httpbin service.
  - name: create-httpbin-service
    description: Create and assert httpbin service to route traffic to
    use:
      template: ../../common/_step_templates/apply-assert-httpbinService.yaml

  # Step 7a: Test GET method matching.
  - name: step-7a-create-httproute-get-method-match
    description: Create HTTPRoute with GET method matching
    try:
      - apply:
          file: 07-httproute-method-get.yaml
      - assert:
          file: 07-assert-httproute-method-get.yaml
    bindings:
      - name: httproute_name
        value: ($httproute_name_get)

  # Step 7b: Verify GET method returns 200.
  - name: step-7b-verify-get-method-returns-200
    description: Verify GET method on /get returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "GET"
      - name: route_path
        value: "/get"
      - name: expected_status
        value: "200"

  # Step 7c: Verify POST method on GET route returns 404.
  - name: step-7c-verify-post-on-get-route-returns-404
    description: Verify POST method on GET route returns 404
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "POST"
      - name: route_path
        value: "/get"
      - name: expected_status
        value: "404"

  # Step 8a: Create HTTPRoute for POST method matching.
  - name: step-8a-create-httproute-post-method-match
    description: Create HTTPRoute with POST method matching
    try:
      - apply:
          file: 08-httproute-method-post.yaml
      - assert:
          file: 08-assert-httproute-method-post.yaml
    bindings:
      - name: httproute_name
        value: ($httproute_name_post)

  # Step 8b: Verify POST method returns 200.
  - name: step-8b-verify-post-method-returns-200
    description: Verify POST method on /post returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "POST"
      - name: route_path
        value: "/post"
      - name: expected_status
        value: "200"

  # Step 8c: Verify GET method on POST route returns 404.
  - name: step-8c-verify-get-on-post-route-returns-404
    description: Verify GET method on POST route returns 404
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "GET"
      - name: route_path
        value: "/post"
      - name: expected_status
        value: "404"

  # Step 9a: Create HTTPRoute for PUT method matching.
  - name: step-9a-create-httproute-put-method-match
    description: Create HTTPRoute with PUT method matching
    try:
      - apply:
          file: 09-httproute-method-put.yaml
      - assert:
          file: 09-assert-httproute-method-put.yaml
    bindings:
      - name: httproute_name
        value: ($httproute_name_put)

  # Step 9b: Verify PUT method returns 200.
  - name: step-9b-verify-put-method-returns-200
    description: Verify PUT method on /put returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "PUT"
      - name: route_path
        value: "/put"
      - name: expected_status
        value: "200"

  # Step 9c: Verify GET method on PUT route returns 404.
  - name: step-9c-verify-get-on-put-route-returns-404
    description: Verify GET method on PUT route returns 404
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "GET"
      - name: route_path
        value: "/put"
      - name: expected_status
        value: "404"

  # Step 10a: Create HTTPRoute for DELETE method matching.
  - name: step-10a-create-httproute-delete-method-match
    description: Create HTTPRoute with DELETE method matching
    try:
      - apply:
          file: 10-httproute-method-delete.yaml
      - assert:
          file: 10-assert-httproute-method-delete.yaml
    bindings:
      - name: httproute_name
        value: ($httproute_name_delete)

  # Step 10b: Verify DELETE method returns 200.
  - name: step-10b-verify-delete-method-returns-200
    description: Verify DELETE method on /delete returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "DELETE"
      - name: route_path
        value: "/delete"
      - name: expected_status
        value: "200"

  # Step 10c: Verify GET method on DELETE route returns 404.
  - name: step-10c-verify-get-on-delete-route-returns-404
    description: Verify GET method on DELETE route returns 404
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "GET"
      - name: route_path
        value: "/delete"
      - name: expected_status
        value: "404"

  # Step 11a: Create HTTPRoute for PATCH method matching.
  - name: step-11a-create-httproute-patch-method-match
    description: Create HTTPRoute with PATCH method matching
    try:
      - apply:
          file: 11-httproute-method-patch.yaml
      - assert:
          file: 11-assert-httproute-method-patch.yaml
    bindings:
      - name: httproute_name
        value: ($httproute_name_patch)

  # Step 11b: Verify PATCH method returns 200.
  - name: step-11b-verify-patch-method-returns-200
    description: Verify PATCH method on /patch returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "PATCH"
      - name: route_path
        value: "/patch"
      - name: expected_status
        value: "200"

  # Step 11c: Verify GET method on PATCH route returns 404.
  - name: step-11c-verify-get-on-patch-route-returns-404
    description: Verify GET method on PATCH route returns 404
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "GET"
      - name: route_path
        value: "/patch"
      - name: expected_status
        value: "404"

  # Step 12a: Create HTTPRoute with multiple HTTP methods.
  - name: step-12a-create-httproute-multiple-methods
    description: Create HTTPRoute with multiple HTTP methods (GET, POST, PUT) in a single rule
    try:
      - apply:
          file: 12-httproute-multiple-methods.yaml
      - assert:
          file: 12-assert-httproute-multiple-methods.yaml
    bindings:
      - name: httproute_name
        value: ($httproute_name_multiple)

  # Step 12b: Verify GET method on /anything returns 200.
  - name: step-12b-verify-get-on-anything-returns-200
    description: Verify GET method on /anything returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "GET"
      - name: route_path
        value: "/anything"
      - name: expected_status
        value: "200"

  # Step 12c: Verify POST method on /anything returns 200.
  - name: step-12c-verify-post-on-anything-returns-200
    description: Verify POST method on /anything returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "POST"
      - name: route_path
        value: "/anything"
      - name: expected_status
        value: "200"

  # Step 12d: Verify PUT method on /anything returns 200.
  - name: step-12d-verify-put-on-anything-returns-200
    description: Verify PUT method on /anything returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "PUT"
      - name: route_path
        value: "/anything"
      - name: expected_status
        value: "200"

  # Step 12e: Verify DELETE method on /anything returns 404 (not in allowed methods).
  - name: step-12e-verify-delete-on-anything-returns-404
    description: Verify DELETE method on /anything returns 404
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "DELETE"
      - name: route_path
        value: "/anything"
      - name: expected_status
        value: "404"

  # Step 13a: Create HTTPRoute with method matching combined with path matching.
  - name: step-13a-create-httproute-method-path-combined
    description: Create HTTPRoute with method matching combined with different path matching
    try:
      - apply:
          file: 13-httproute-method-path-combined.yaml
      - assert:
          file: 13-assert-httproute-method-path-combined.yaml
    bindings:
      - name: httproute_name
        value: ($httproute_name_combined)

  # Step 13b: Verify GET /get returns 200.
  - name: step-13b-verify-get-on-get-path-returns-200
    description: Verify GET method on /get returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "GET"
      - name: route_path
        value: "/get"
      - name: expected_status
        value: "200"

  # Step 13c: Verify POST /get returns 404 (wrong method for /get path).
  - name: step-13c-verify-post-on-get-path-returns-404
    description: Verify POST method on /get returns 404
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "POST"
      - name: route_path
        value: "/get"
      - name: expected_status
        value: "404"

  # Step 13d: Verify POST /post returns 200.
  - name: step-13d-verify-post-on-post-path-returns-200
    description: Verify POST method on /post returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "POST"
      - name: route_path
        value: "/post"
      - name: expected_status
        value: "200"

  # Step 13e: Verify GET /post returns 404 (wrong method for /post path).
  - name: step-13e-verify-get-on-post-path-returns-404
    description: Verify GET method on /post returns 404
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "GET"
      - name: route_path
        value: "/post"
      - name: expected_status
        value: "404"

  # Step 13f: Verify GET /anything returns 200 (any method allowed).
  - name: step-13f-verify-get-on-anything-path-returns-200
    description: Verify GET method on /anything returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "GET"
      - name: route_path
        value: "/anything"
      - name: expected_status
        value: "200"

  # Step 13g: Verify POST /anything returns 200 (any method allowed).
  - name: step-13g-verify-post-on-anything-path-returns-200
    description: Verify POST method on /anything returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "POST"
      - name: route_path
        value: "/anything"
      - name: expected_status
        value: "200"

  # Step 13h: Verify DELETE /anything returns 200 (any method allowed).
  - name: step-13h-verify-delete-on-anything-path-returns-200
    description: Verify DELETE method on /anything returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "DELETE"
      - name: route_path
        value: "/anything"
      - name: expected_status
        value: "200"

  # Step 14a: Create HTTPRoute for update test (initially GET only).
  - name: step-14a-create-httproute-update-test-initial
    description: Create HTTPRoute with GET method only for update test
    try:
      - apply:
          file: 14-httproute-update-test-initial.yaml
      - assert:
          file: 14-assert-httproute-update-test-initial.yaml
    bindings:
      - name: httproute_name
        value: ($httproute_name_update_test)

  # Step 14b: Verify GET method on initial route returns 200.
  - name: step-14b-verify-get-on-update-test-initial-returns-200
    description: Verify GET method on /status/200 returns 200
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "GET"
      - name: route_path
        value: "/status/200"
      - name: expected_status
        value: "200"

  # Step 14c: Verify POST method on initial route returns 404.
  - name: step-14c-verify-post-on-update-test-initial-returns-404
    description: Verify POST method on /status/200 returns 404 before update
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "POST"
      - name: route_path
        value: "/status/200"
      - name: expected_status
        value: "404"

  # Step 14d: Update HTTPRoute to accept both GET and POST.
  - name: step-14d-update-httproute-update-test
    description: Get current Kong resources, update HTTPRoute to accept both GET and POST methods, and verify old resources are deleted.
    try:
      - script:
          env:
            - name: NAMESPACE
              value: ($namespace)
            - name: GATEWAY_NAME
              value: ($gateway_name)
            - name: GATEWAY_NAMESPACE
              value: ($gateway_namespace)
            - name: HTTP_ROUTE_NAME
              value: ($httproute_name_update_test)
            - name: HTTP_ROUTE_NAMESPACE
              value: ($http_route_namespace)
            - name: RESOURCE_TYPES
              value: "kongroutes.configuration.konghq.com"
          content: |
            bash ../../common/scripts/get_kong_resources.sh
          outputs:
            - name: old_resources
              value: (json_parse($stdout))
      - apply:
          file: 14-httproute-update-test-updated.yaml
      - script:
          env:
            - name: RESOURCES_JSON
              value: (to_string($old_resources))
          content: |
            bash ../../common/scripts/wait_for_kong_resources_deletion.sh
      - assert:
          file: 14-assert-httproute-update-test-updated.yaml
    bindings:
      - name: httproute_name
        value: ($httproute_name_update_test)

  # Step 14e: Verify GET method still works after update.
  - name: step-14e-verify-get-on-update-test-updated-returns-200
    description: Verify GET method on /update-test still returns 200 after update
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "GET"
      - name: route_path
        value: "/status/200"
      - name: expected_status
        value: "200"

  # Step 14f: Verify POST method now works after update.
  - name: step-14f-verify-post-on-update-test-updated-returns-200
    description: Verify POST method on /status/200 returns 200 after update
    use:
      template: ../../common/_step_templates/verify-method-match-routing.yaml
    bindings:
      - name: http_method
        value: "POST"
      - name: route_path
        value: "/status/200"
      - name: expected_status
        value: "200"

  catch:
    # Capture debug snapshot on test failure for CI debugging.
    - description: Capture debug snapshot
      script:
        env:
          - name: TEST_NAME
            value: hybridgateway-httproute-method-matching
          - name: NAMESPACE
            value: ($namespace)
          - name: OPERATOR_NAMESPACE
            value: kong-system
        content: |
          bash ../../common/scripts/debug_snapshot.sh
