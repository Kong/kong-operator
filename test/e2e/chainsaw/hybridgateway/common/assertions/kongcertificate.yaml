---
# Template for asserting KongCertificate resources
#
# Required bindings:
#   - namespace: Resource namespace (e.g., "kong")
#   - gateway_name: Gateway name (e.g., "kong-foo")
#   - gateway_namespace: Gateway namespace (e.g., "kong")
#   - secret_name: Secret name (e.g., "test-tls-secret")
#   - secret_namespace: Secret namespace (e.g., "kong")
#   - konnectgatewaycontrolplane_name: Name of the KonnectGatewayControlPlane
apiVersion: configuration.konghq.com/v1alpha1
kind: KongCertificate
metadata:
  namespace: ($namespace)
  (labels."gateway-operator.konghq.com/hybrid-gateways-name" == ($gateway_name)): true
  (labels."gateway-operator.konghq.com/hybrid-gateways-namespace" == ($gateway_namespace)): true
  (labels."gateway-operator.konghq.com/managed-by" == 'Gateway'): true
  (annotations."gateway-operator.konghq.com/hybrid-gateways" == join('/', [($gateway_namespace), ($gateway_name)])): true
  ownerReferences:
  - apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    name: ($gateway_name)
    controller: true
spec:
  secretRef:
    name: ($secret_name)
    namespace: ($secret_namespace)
  controlPlaneRef:
    type: konnectNamespacedRef
    konnectNamespacedRef:
      name: ($konnectgatewaycontrolplane_name)
status:
  (conditions[?type == 'Programmed']):
    - status: 'True'
      reason: Programmed
  (conditions[?type == 'ControlPlaneRefValid']):
    - status: 'True'
      reason: Valid
  (conditions[?type == 'APIAuthResolvedRef']):
    - status: 'True'
      reason: ResolvedRef
  (conditions[?type == 'APIAuthValid']):
    - status: 'True'
      reason: Valid
