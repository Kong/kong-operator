# Template for verifying rate-limiting plugin functionality.
#
# Required bindings:
#   - gateway_name: Name of the Gateway
#   - gateway_namespace: Namespace of the Gateway
#   - route_path: HTTP path to test
#   - expected_rate_limit: Expected rate limit value (e.g., "20" or "30")
#   - host_header: (optional) Host header to send with requests
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: StepTemplate
metadata:
  name: verify-rate-limiting-plugin
spec:
  try:
    # Get proxy IP with validation
    - script:
        env:
          - name: GATEWAY_NAME
            value: ($gateway_name)
          - name: GATEWAY_NAMESPACE
            value: ($gateway_namespace)
        content: |
          bash ../../common/scripts/proxy_ip_address.sh
        outputs:
          - name: proxy_ip
            value: (json_parse($stdout).proxy_ip_address)
        check:
          (json_parse($stdout).proxy_ip_address != null): true

    # Verify rate-limiting header
    - script:
        env:
          - name: PROXY_IP
            value: ($proxy_ip)
          - name: ROUTE_PATH
            value: ($route_path)
          - name: EXPECTED_LIMIT
            value: ($expected_rate_limit)
          - name: HOST
            value: ($host_header)
        content: |
          bash ../../common/scripts/verify_rate_limit_header.sh
        check:
          (json_parse($stdout).success): true
