# Gateway TLS secret cross-namespace reference test scenario.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: gateway-tls-secret-cross-namespace
spec:
  description: |
    This test validates cross-namespace Gateway to Secret references for TLS listeners.
    It verifies the Gateway listener ResolvedRefs condition is False without a
    ReferenceGrant and that KongCertificate/KongSNI are not provisioned. After
    creating a ReferenceGrant, it asserts the Gateway is programmed and the
    KongCertificate/KongSNI exist but are not programmed until a KongReferenceGrant
    is added.

  timeouts:
    apply: 120s
    assert: 120s
    cleanup: 300s
    delete: 300s
    exec: 120s

  bindings:
    # Common bindings.
    - name: test_name
      value: ($namespace)
    - name: konnect_token
      value: (env('KONNECT_TOKEN'))
    - name: sni_hostname
      value: (join('.', ['*', ($test_name), 'example.com']))
    - name: cert_secret_name
      value: test-tls-secret
    - name: secret_namespace
      value: (join('-', [($namespace), 'tls-secrets']))
    - name: cert_secret_namespace
      value: ($secret_namespace)
    - name: listener_https_port
      value: 443
    - name: listener_http_port
      value: 80
    - name: konnect_url
      value: (env('KONNECT_SERVER_URL') || 'eu.api.konghq.tech')
    - name: gateway_image
      value: (env('GATEWAY_IMAGE') || 'kong/kong-gateway:3.12')
    - name: gateway_name
      value: (join('-', [($test_name), 'gateway']))
    - name: gateway_namespace
      value: ($namespace)
    - name: reference_grant_name
      value: (join('-', [($test_name), 'gateway-secret-reference-grant']))
    - name: reference_grant_namespace
      value: ($secret_namespace)
    - name: kong_reference_grant_name
      value: (join('-', [($test_name), 'kong-secret-reference-grant']))

  steps:
    # Step 1: Create the namespace for TLS secrets.
    - name: Create-secret-namespace
      description: Create the namespace that holds the TLS secret.
      use:
        template: ../common/_step_templates/apply-assert-namespace.yaml
      bindings:
        - name: namespace_name
          value: ($secret_namespace)

    # Step 2: Create the TLS secret in the separate namespace.
    - name: Create-tls-secret
      description: Create TLS Secret in a different namespace for the Gateway TLS listener.
      use:
        template: ../common/_step_templates/apply-assert-tlsSecret.yaml

    # Step 3: Create the KonnectAPIAuthConfiguration to authenticate with Konnect.
    - name: Create-konnect-api-auth
      description: Create KonnectAPIAuthConfiguration for the test.
      use:
        template: ../common/_step_templates/apply-assert-konnectAPIAuthConfiguration.yaml

    # Step 4: Create the GatewayConfiguration that defines the hybrid gateway setup.
    - name: Create-gateway-configuration
      description: Create GatewayConfiguration for the test.
      use:
        template: ../common/_step_templates/apply-assert-gatewayConfiguration.yaml

    # Step 5: Create the GatewayClass that will be used by the Gateway.
    - name: Create-gateway-class
      description: Create GatewayClass for the test.
      use:
        template: ../common/_step_templates/apply-assert-gatewayClass.yaml

    # Step 6: Create the Gateway with a cross-namespace TLS secret reference.
    - name: Create-gateway
      description: Create Gateway with TLS listener referencing a secret in another namespace.
      try:
        - apply:
            file: 01-gateway.yaml

    # Step 7: Assert Gateway listener ResolvedRefs is False without ReferenceGrant.
    - name: Assert-gateway-resolvedrefs-false
      description: Verify Gateway listener ResolvedRefs is False before ReferenceGrant.
      try:
        - assert:
            file: 02-assert-gateway-resolvedrefs-false.yaml

    # Step 8: Verify KongCertificate has not been created yet.
    - name: Assert-no-kongcertificate
      description: Verify no KongCertificate exists before ReferenceGrant.
      try:
        - script:
            env:
              - name: GATEWAY_NAME
                value: ($gateway_name)
              - name: NAMESPACE
                value: ($gateway_namespace)
            content: |
              bash ../common/scripts/kongCertificate_name.sh
            check:
              ($error != null): true
              (contains($stdout, 'No KongCertificate found for Gateway')): true

    # Step 9: Verify KongSNI has not been created yet.
    - name: Assert-no-kongsni
      description: Verify no KongSNI exists before ReferenceGrant.
      try:
        - script:
            env:
              - name: NAMESPACE
                value: ($gateway_namespace)
              - name: GATEWAY_NAME
                value: ($gateway_name)
            content: |
              bash ../common/scripts/assert_no_kongsni.sh

    # Step 10: Create ReferenceGrant to allow Gateway -> Secret cross-namespace reference.
    - name: Create-reference-grant
      description: Create ReferenceGrant to allow the Gateway to reference the TLS secret.
      try:
        - apply:
            file: 03-referencegrant.yaml

    # Step 11: Assert Gateway is programmed after ReferenceGrant.
    - name: Assert-gateway-programmed
      description: Verify Gateway reaches programmed state after ReferenceGrant.
      bindings:
        - name: kong_namespace
          value: ($gateway_namespace)
      try:
        - assert:
            file: ../common/assertions/gateway.yaml

    # Step 12: Assert Gateway listener ResolvedRefs is True after ReferenceGrant.
    - name: Assert-gateway-resolvedrefs-true
      description: Verify Gateway listener ResolvedRefs is True after ReferenceGrant.
      try:
        - assert:
            file: 04-assert-gateway-resolvedrefs-true.yaml

    # Step 13: Verify that the KonnectGatewayControlPlane is created and programmed.
    - name: Assert-konnect-gateway-control-plane
      description: Assert that the KonnectGatewayControlPlane resource is created and synchronized.
      use:
        template: ../common/_step_templates/assert-konnectGatewayControlPlane.yaml

    # Step 14: Assert KongCertificate exists but is not programmed.
    - name: Assert-kong-certificate-not-programmed
      description: Verify KongCertificate exists but is not programmed before KongReferenceGrant.
      try:
        - script:
            env:
              - name: NAMESPACE
                value: ($gateway_namespace)
            content: |
              bash ../common/scripts/konnecGatewayControlplane_name.sh
            outputs:
              - name: konnectgatewaycontrolplane_name
                value: (json_parse($stdout).cp_name)
        - assert:
            file: 05-assert-kongcertificate-not-programmed.yaml

    # Step 15: Assert KongSNI exists but is not programmed.
    - name: Assert-kong-sni-not-programmed
      description: Verify KongSNI exists but is not programmed before KongReferenceGrant.
      try:
        - script:
            env:
              - name: GATEWAY_NAME
                value: ($gateway_name)
              - name: NAMESPACE
                value: ($gateway_namespace)
            content: |
              bash ../common/scripts/kongCertificate_name.sh
            outputs:
              - name: certificate_name
                value: (json_parse($stdout).certificate_name)
        - assert:
            file: 06-assert-kongsni-not-programmed.yaml

    # Step 16: Create KongReferenceGrant to allow KongCertificate -> Secret cross-namespace reference.
    - name: Create-kong-reference-grant
      description: Create KongReferenceGrant to allow KongCertificate to reference the TLS secret.
      try:
        - apply:
            file: 07-kongreferencegrant.yaml

    # Step 17: Verify that the KongCertificate is programmed after KongReferenceGrant.
    - name: Assert-kong-certificate-programmed
      description: Assert that the KongCertificate resource is programmed for the TLS secret.
      use:
        template: ../common/_step_templates/assert-kongCertificate.yaml
      bindings:
        - name: namespace
          value: ($gateway_namespace)

    # Step 18: Verify that the KongSNI is programmed after KongReferenceGrant.
    - name: Assert-kong-sni-programmed
      description: Assert that the KongSNI resource is programmed for the SNI hostname.
      use:
        template: ../common/_step_templates/assert-kongSNI.yaml
      bindings:
        - name: namespace
          value: ($gateway_namespace)

  catch:
    - describe:
        apiVersion: gateway.networking.k8s.io/v1
        kind: Gateway
        name: ($gateway_name)
        namespace: ($gateway_namespace)

    - describe:
        apiVersion: gateway.networking.k8s.io/v1beta1
        kind: ReferenceGrant
        namespace: ($secret_namespace)

    - describe:
        apiVersion: configuration.konghq.com/v1alpha1
        kind: KongReferenceGrant
        namespace: ($secret_namespace)

    - describe:
        apiVersion: configuration.konghq.com/v1alpha1
        kind: KonnectGatewayControlPlane
        namespace: ($namespace)

    - describe:
        apiVersion: configuration.konghq.com/v1alpha1
        kind: KongCertificate
        namespace: ($gateway_namespace)

    - describe:
        apiVersion: configuration.konghq.com/v1alpha1
        kind: KongSNI
        namespace: ($gateway_namespace)

    - describe:
        apiVersion: v1
        kind: Secret
        name: ($cert_secret_name)
        namespace: ($cert_secret_namespace)

    - script:
        content: |
          echo "=== Gateway YAML (with finalizers) ==="
          kubectl get gateway -n ${GATEWAY_NAMESPACE} ${GATEWAY_NAME} -o yaml || echo "Gateway not found"
          echo "=== KonnectAPIAuthConfiguration YAML (with finalizers) ==="
          kubectl get konnectapiAuthConfiguration -n ${NAMESPACE} -o yaml || echo "KonnectAPIAuthConfiguration not found"
          echo "=== GatewayConfiguration YAML ==="
          kubectl get gatewayconfiguration -n ${NAMESPACE} -o yaml || echo "GatewayConfiguration not found"
          echo "=== KonnectGatewayControlPlane YAML ==="
          kubectl get konnectgatewaycontrolplane -n ${NAMESPACE} -o yaml || echo "KonnectGatewayControlPlane not found"
        env:
          - name: GATEWAY_NAME
            value: ($gateway_name)
          - name: GATEWAY_NAMESPACE
            value: ($gateway_namespace)
          - name: NAMESPACE
            value: ($namespace)
