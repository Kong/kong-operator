# Basic HTTPRoute test scenario.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: basic-httproute
spec:
  description: |
    This test validates that the hybrid gateway controller correctly
    processes a basic HTTPRoute with a single service backend.

  bindings:
    # Common bindings.
    - name: test_name
      value: ($namespace)
    - name: konnect_token
      value: (env('KONNECT_TOKEN'))
    - name: konnect_api_auth_namespace
      value: ($namespace)
    - name: sni_hostname
      value: (join('.', ['*', ($test_name), 'example.com']))
    - name: fqdn
      value: (join('.', ['echo', ($test_name), 'example.com']))
    - name: cert_secret_name
      value: test-tls-secret
    - name: cert_secret_namespace
      value: ($namespace)
    - name: listener_https_port
      value: 443
    - name: listener_http_port
      value: 80
    - name: konnect_url
      value: (env('KONNECT_SERVER_URL') || 'eu.api.konghq.tech')
    - name: auth_secret_name
      value: (join('-', [($test_name), 'konnect-auth-secret']))
    - name: auth_secret_namespace
      value: ($namespace)
    - name: konnect_auth_name
      value: (join('-', [($test_name), 'konnect-api-auth']))
    - name: konnect_auth_namespace
      value: ($namespace)
    - name: gateway_image
      value: (env('GATEWAY_IMAGE') || 'kong/kong-gateway:3.12')
    - name: gateway_name
      value: (join('-', [($test_name), 'gateway']))
    - name: gateway_namespace
      value: ($namespace)
    - name: http_route_name
      value: (join('-', [($test_name), 'echo-route']))
    - name: http_route_namespace
      value: ($namespace)
    - name: echo_deployment_name
      value: (join('-', [($test_name), 'echo']))
    - name: echo_deployment_namespace
      value: ($namespace)
    - name: httpbin_deployment_name
      value: (join('-', [($test_name), 'httpbin']))
    - name: httpbin_deployment_namespace
      value: ($namespace)
    - name: http_method
      value: "GET"

  steps:
    # Step 1: Create the TLS secret that will be referenced by the Gateway TLS listener.
    - name: Create-tls-secret
      description: Create TLS Secret for the Gateway TLS listener.
      use:
        template: ../../common/_step_templates/apply-assert-tlsSecret.yaml

    # Step 2a: Create the secret for Konnect authentication.
    - name: Create-auth-secret
      description: Create Secret with Konnect token for KonnectAPIAuthConfiguration.
      use:
        template: ../../common/_step_templates/apply-assert-konnectAuthSecret.yaml

    # Step 2b: Create the KonnectAPIAuthConfiguration to authenticate with Konnect.
    - name: Create-konnect-api-auth
      description: Create KonnectAPIAuthConfiguration for the test.
      use:
        template: ../../common/_step_templates/apply-assert-konnectAPIAuthConfiguration-secretref.yaml

    # Step 3: Create the GatewayConfiguration that defines the hybrid gateway setup.
    - name: Create-gateway-configuration
      description: Create GatewayConfiguration for the test.
      use:
        template: ../../common/_step_templates/apply-assert-gatewayConfiguration.yaml

    # Step 4: Create the GatewayClass that will be used by the Gateway.
    - name: Create-gateway-class
      description: Create GatewayClass for the test.
      use:
        template: ../../common/_step_templates/apply-assert-gatewayClass.yaml

    # Step 5: Create the Gateway with a TLS listener that references the TLS secret.
    - name: Create-gateway
      description: Create Gateway with TLS listener for the test.
      use:
        template: ../../common/_step_templates/apply-assert-gateway.yaml

    # Step 6: Verify that the KonnectGatewayControlPlane is created and synchronized with Konnect.
    - name: Assert-konnect-gateway-control-plane
      description: Assert that the KonnectGatewayControlplane resource is created and synchronized.
      use:
        template: ../../common/_step_templates/assert-konnectGatewayControlPlane.yaml

    # Step 7: Verify that the KongCertificate resource is created from the TLS secret.
    - name: Assert-kong-certificate
      description: Assert that the KongCertificate resource is created for the TLS secret.
      use:
       template: ../../common/_step_templates/assert-kongCertificate.yaml
  
    # Step 8: Verify that the KongSNI resource is created for the SNI hostname.
    - name: Assert-kong-sni
      description: Assert that the KongSNI resource is created for the SNI hostname.
      use:
       template: ../../common/_step_templates/assert-kongSNI.yaml
      bindings:
        - name: resource_type
          value: "kongcertificates.configuration.konghq.com"
  
    # Step 9: Create the echo service that will receive the routed traffic.
    - name: Create-echo-service
      description: Create and assert an echo service to route traffic to.
      use:
        template: ../../common/_step_templates/apply-assert-echoService.yaml

    # Step 10: Create HTTPRoute to route traffic to the echo service.
    # The HTTPRoute is not templated because it is specific to this test case.
    - name: Create-httproute-echo
      description: Create HTTPRoute to route traffic to the echo service.
      try:
        - apply:
            file: 01-httpRoute-echo.yaml
        - assert:
            file: 02-httpRoute-echo-assert.yaml
      bindings:
        - name: route_hosts
          value:
            - ($fqdn)
    
    # Step 11: Verify that the HTTPRoute is translated into a KongRoute resource.
    - name: Assert-kong-route
      description: Assert that the KongRoute resource is created for the HTTPRoute.
      use:
        template: ../../common/_step_templates/assert-kongRoute.yaml
      bindings:
        - name: route_paths
          value: 
            - "~/echo$"
            - "/echo/"
        - name: strip_path
          value: false
        - name: resource_type
          value: "kongservices.configuration.konghq.com"
    
    # Step 12: Verify that the HTTPRoute backend is translated into a KongService resource.
    - name: Assert-kong-service
      description: Assert that the KongService resource is created for the HTTPRoute.
      use:
        template: ../../common/_step_templates/assert-kongService.yaml

    # Step 13: Verify that the HTTPRoute backend is translated into a KongUpstream resource.
    - name: Assert-kong-upstream
      description: Assert that the KongUpstream resource is created for the HTTPRoute.
      use:
        template: ../../common/_step_templates/assert-kongUpstream.yaml
    
    # Step 14: Verify that the KongUpstream has KongTarget resources created for it.
    - name: Assert-kong-target
      description: Assert that the KongTarget resource is created for the KongUpstream.
      use:
        template: ../../common/_step_templates/assert-kongTarget.yaml
      bindings:
        - name: resource_type
          value: "kongupstreams.configuration.konghq.com"
        - name: target_weight
          value: 1
    # Step 15: Verify that the TLS certificate deployed to the dataplane matches the TLS secret.
    - name: Verify-TLS-Fingerprint
      description: Verify that the TLS certificate deployed to the dataplane matches the TLS secret.
      use:
        template: ../../common/_step_templates/verify-gateway-tls-fingerprint.yaml

    # Step 16: Verify that the dataplane is configured, traffic can be routed, and TLS certificates are working.
    # The verification is done by sending an HTTPS request to the gateway and checking the response from the host.
    - name: Verify-HTTPS-traffic-from-host
      description: Verify that HTTPS traffic can be routed through the gateway to the echo service from the host.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/echo"
        - name: insecure
          value: "true"
   
    # Step 17: Verify that the dataplane is configured, traffic can be routed, and TLS certificates are working.
    # The verification is done by sending an HTTPS request to the gateway and checking the response from within the cluster.
    - name: Verify-HTTPS-traffic-from-cluster
      description: Verify that HTTPS traffic can be routed through the gateway to the echo service from the cluster.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/echo"
        - name: insecure
          value: "true"

    # Step 18: Verify that HTTP traffic can be routed through the gateway to the echo service from the host.
    - name: Verify-HTTP-traffic-from-host
      description: Verify that HTTP traffic can be routed through the gateway to the echo service from the host.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/echo"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)

    # Step 19: Verify that HTTP traffic can be routed through the gateway to the echo service from within the cluster.
    - name: Verify-HTTP-traffic-from-cluster
      description: Verify that HTTP traffic can be routed through the gateway to the echo service from the cluster.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/echo"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 20: Create the httpbin service that will receive the routed traffic.
    - name: Create-httpbin-service
      description: Create and assert an httpbin service to route traffic to.
      use:
        template: ../../common/_step_templates/apply-assert-httpbinService.yaml
    
    # Step 21: Get current Kong resources, update HTTPRoute, and verify old resources are deleted.
    - name: Update-httproute-and-verify-cleanup
      description: Get current Kong resource names, update HTTPRoute to httpbin backend, and verify old echo resources are deleted.
      try:
        - script:
            env:
              - name: NAMESPACE
                value: ($namespace)
              - name: GATEWAY_NAME
                value: ($gateway_name)
              - name: GATEWAY_NAMESPACE
                value: ($gateway_namespace)
              - name: HTTP_ROUTE_NAME
                value: ($http_route_name)
              - name: HTTP_ROUTE_NAMESPACE
                value: ($http_route_namespace)
              - name: RESOURCE_TYPES
                value: "kongservices.configuration.konghq.com,kongroutes.configuration.konghq.com,kongupstreams.configuration.konghq.com,kongtargets.configuration.konghq.com"
            content: |
              bash ../../common/scripts/get_kong_resources.sh
            outputs:
              - name: old_resources
                value: (json_parse($stdout))
        - apply:
            file: 03-update-httpRoute.yaml
        - script:
            env:
              - name: RESOURCES_JSON
                value: (to_string($old_resources))
            content: |
              bash ../../common/scripts/wait_for_kong_resources_deletion.sh
        - assert:
            file: 04-assert-update-httpRoute.yaml
      bindings:
        - name: route_hosts
          value:
            - ($fqdn)
    
    # Step 22: Verify that the HTTPRoute backend is translated into a KongService resource for httpbin.
    - name: Assert-kong-service-httpbin
      description: Assert that the KongService resource is created for the httpbin backend.
      use:
        template: ../../common/_step_templates/assert-kongService.yaml
    
    # Step 23: Verify that the updated HTTPRoute is translated into a KongRoute resource.
    - name: Assert-kong-route-updated
      description: Assert that the KongRoute resource is updated for the HTTPRoute.
      use:
        template: ../../common/_step_templates/assert-kongRoute.yaml
      bindings:
        - name: route_paths
          value: 
            - "~/get$"
            - "~/post$"
            - "~/put$"
            - "~/patch$"
            - "~/delete$"
            - "~/status$"
            - "/status/"
        - name: route_methods
          value:
            - "GET"
            - "POST"
            - "PUT"
            - "PATCH"
            - "DELETE"
        - name: strip_path
          value: false
        - name: resource_type
          value: "kongservices.configuration.konghq.com"

    # Step 24: Verify that the HTTPRoute backend is translated into a KongUpstream resource for httpbin.
    - name: Assert-kong-upstream-httpbin
      description: Assert that the KongUpstream resource is created for the httpbin backend.
      use:
        template: ../../common/_step_templates/assert-kongUpstream.yaml
    
    # Step 25: Verify that the KongUpstream has KongTarget resources created for httpbin.
    - name: Assert-kong-target-httpbin
      description: Assert that the KongTarget resource is created for the httpbin KongUpstream.
      use:
        template: ../../common/_step_templates/assert-kongTarget.yaml
      bindings:
        - name: resource_type
          value: "kongupstreams.configuration.konghq.com"
        - name: target_weight
          value: 1
    
    # Step 26: Test GET /get endpoint from host.
    - name: Verify-GET-traffic-from-host
      description: Verify that GET requests to /get work from the host.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 27: Test POST /post endpoint from host.
    - name: Verify-POST-traffic-from-host
      description: Verify that POST requests to /post work from the host.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/post"
        - name: http_method
          value: "POST"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 28: Test PUT /put endpoint from host.
    - name: Verify-PUT-traffic-from-host
      description: Verify that PUT requests to /put work from the host.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/put"
        - name: http_method
          value: "PUT"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 29: Test PATCH /patch endpoint from host.
    - name: Verify-PATCH-traffic-from-host
      description: Verify that PATCH requests to /patch work from the host.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/patch"
        - name: http_method
          value: "PATCH"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 30: Test DELETE /delete endpoint from host.
    - name: Verify-DELETE-traffic-from-host
      description: Verify that DELETE requests to /delete work from the host.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/delete"
        - name: http_method
          value: "DELETE"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 31: Test GET /get endpoint from cluster.
    - name: Verify-GET-traffic-from-cluster
      description: Verify that GET requests to /get work from within the cluster.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 32: Test POST /post endpoint from cluster.
    - name: Verify-POST-traffic-from-cluster
      description: Verify that POST requests to /post work from within the cluster.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/post"
        - name: http_method
          value: "POST"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 33: Test PUT /put endpoint from cluster.
    - name: Verify-PUT-traffic-from-cluster
      description: Verify that PUT requests to /put work from within the cluster.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/put"
        - name: http_method
          value: "PUT"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 34: Test PATCH /patch endpoint from cluster.
    - name: Verify-PATCH-traffic-from-cluster
      description: Verify that PATCH requests to /patch work from within the cluster.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/patch"
        - name: http_method
          value: "PATCH"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 35: Test DELETE /delete endpoint from cluster.
    - name: Verify-DELETE-traffic-from-cluster
      description: Verify that DELETE requests to /delete work from within the cluster.
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/delete"
        - name: http_method
          value: "DELETE"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 36: Test GET /get endpoint from host via HTTPS.
    - name: Verify-GET-HTTPS-traffic-from-host
      description: Verify that GET requests to /get work from the host via HTTPS.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: insecure
          value: "true"
    
    # Step 37: Test POST /post endpoint from host via HTTPS.
    - name: Verify-POST-HTTPS-traffic-from-host
      description: Verify that POST requests to /post work from the host via HTTPS.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/post"
        - name: http_method
          value: "POST"
        - name: insecure
          value: "true"
    
    # Step 38: Test PUT /put endpoint from host via HTTPS.
    - name: Verify-PUT-HTTPS-traffic-from-host
      description: Verify that PUT requests to /put work from the host via HTTPS.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/put"
        - name: http_method
          value: "PUT"
        - name: insecure
          value: "true"
    
    # Step 39: Test PATCH /patch endpoint from host via HTTPS.
    - name: Verify-PATCH-HTTPS-traffic-from-host
      description: Verify that PATCH requests to /patch work from the host via HTTPS.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/patch"
        - name: http_method
          value: "PATCH"
        - name: insecure
          value: "true"
    
    # Step 40: Test DELETE /delete endpoint from host via HTTPS.
    - name: Verify-DELETE-HTTPS-traffic-from-host
      description: Verify that DELETE requests to /delete work from the host via HTTPS.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/delete"
        - name: http_method
          value: "DELETE"
        - name: insecure
          value: "true"
    
    # Step 41: Test GET /get endpoint from cluster via HTTPS.
    - name: Verify-GET-HTTPS-traffic-from-cluster
      description: Verify that GET requests to /get work from within the cluster via HTTPS.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: insecure
          value: "true"
    
    # Step 42: Test POST /post endpoint from cluster via HTTPS.
    - name: Verify-POST-HTTPS-traffic-from-cluster
      description: Verify that POST requests to /post work from within the cluster via HTTPS.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/post"
        - name: http_method
          value: "POST"
        - name: insecure
          value: "true"
    
    # Step 43: Test PUT /put endpoint from cluster via HTTPS.
    - name: Verify-PUT-HTTPS-traffic-from-cluster
      description: Verify that PUT requests to /put work from within the cluster via HTTPS.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/put"
        - name: http_method
          value: "PUT"
        - name: insecure
          value: "true"
    
    # Step 44: Test PATCH /patch endpoint from cluster via HTTPS.
    - name: Verify-PATCH-HTTPS-traffic-from-cluster
      description: Verify that PATCH requests to /patch work from within the cluster via HTTPS.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/patch"
        - name: http_method
          value: "PATCH"
        - name: insecure
          value: "true"
    
    # Step 45: Test DELETE /delete endpoint from cluster via HTTPS.
    - name: Verify-DELETE-HTTPS-traffic-from-cluster
      description: Verify that DELETE requests to /delete work from within the cluster via HTTPS.
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/delete"
        - name: http_method
          value: "DELETE"
        - name: insecure
          value: "true"

  catch:
    # Capture debug snapshot on test failure for CI debugging.
    - description: Capture debug snapshot
      script:
        env:
          - name: TEST_NAME
            value: hybridgateway-basic-httproute
          - name: NAMESPACE
            value: ($namespace)
          - name: OPERATOR_NAMESPACE
            value: kong-system
        content: |
          bash ../../common/scripts/debug_snapshot.sh
