# HTTPRoute filters test scenario
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: httproute-filters
spec:
  description: |
    This test validates that the hybrid gateway controller correctly
    processes the currently supported filters in HTTPRoute, including:
    `RequestHeaderModifier`, `ResponseHeaderModifier`.

  bindings:
    # Common bindings.
    - name: test_name
      value: ($namespace)
    - name: konnect_token
      value: (env('KONNECT_TOKEN'))
    - name: sni_hostname
      value: (join('.', ['*', ($test_name), 'example.com']))
    - name: fqdn
      value: (join('.', ['httpbin', ($test_name), 'example.com']))
    - name: response_filter_fqdn
      value: (join('.', ['httpbin-response', ($test_name), 'example.com']))
    - name: cert_secret_name
      value: test-tls-secret
    - name: cert_secret_namespace
      value: ($namespace)
    - name: listener_https_port
      value: 443
    - name: listener_http_port
      value: 80
    - name: konnect_url
      value: (env('KONNECT_SERVER_URL') || 'eu.api.konghq.tech')
    - name: gateway_image
      value: (env('GATEWAY_IMAGE') || 'kong/kong-gateway:3.12')
    - name: gateway_name
      value: (join('-', [($test_name), 'gateway']))
    - name: gateway_namespace
      value: ($namespace)
    - name: http_route_name
      value: (join('-', [($test_name), 'httpbin-request-header-modifier']))
    - name: http_route_namespace
      value: ($namespace)
    - name: http_route_response_filter_name
      value: (join('-', [($test_name), 'httpbin-response-header-modifier']))
    - name: http_route_response_filter_namespace
      value: ($namespace)
    - name: combined_filters_fqdn
      value: (join('.', ['httpbin-combined', ($test_name), 'example.com']))
    - name: http_route_combined_filters_name
      value: (join('-', [($test_name), 'httpbin-combined-filters']))
    - name: http_route_combined_filters_namespace
      value: ($namespace)
    - name: httpbin_deployment_name
      value: (join('-', [($test_name), 'httpbin']))
    - name: httpbin_deployment_namespace
      value: ($namespace)
    - name: http_method
      value: "GET"

  steps:
    # Step 1: Create the TLS secret that will be referenced by the Gateway TLS listener.
    - name: Create-tls-secret
      description: Create TLS Secret for the Gateway TLS listener.
      use:
        template: ../../common/_step_templates/apply-assert-tlsSecret.yaml

    # Step 2: Create the KonnectAPIAuthConfiguration to authenticate with Konnect.
    - name: Create-konnect-api-auth
      description: Create KonnectAPIAuthConfiguration for the test.
      use:
        template: ../../common/_step_templates/apply-assert-konnectAPIAuthConfiguration.yaml

    # Step 3: Create the GatewayConfiguration that defines the hybrid gateway setup.
    - name: Create-gateway-configuration
      description: Create GatewayConfiguration for the test.
      use:
        template: ../../common/_step_templates/apply-assert-gatewayConfiguration.yaml

    # Step 4: Create the GatewayClass that will be used by the Gateway.
    - name: Create-gateway-class
      description: Create GatewayClass for the test.
      use:
        template: ../../common/_step_templates/apply-assert-gatewayClass.yaml

    # Step 5: Create the Gateway with a TLS listener that references the TLS secret.
    - name: Create-gateway
      description: Create Gateway with TLS listener for the test.
      use:
        template: ../../common/_step_templates/apply-assert-gateway.yaml

    # Step 6: Verify that the KonnectGatewayControlPlane is created and synchronized with Konnect.
    - name: Assert-konnect-gateway-control-plane
      description: Assert that the KonnectGatewayControlplane resource is created and synchronized.
      use:
        template: ../../common/_step_templates/assert-konnectGatewayControlPlane.yaml

    # Step 7: Verify that the KongCertificate resource is created from the TLS secret.
    - name: Assert-kong-certificate
      description: Assert that the KongCertificate resource is created for the TLS secret.
      use:
       template: ../../common/_step_templates/assert-kongCertificate.yaml
  
    # Step 8: Verify that the KongSNI resource is created for the SNI hostname.
    - name: Assert-kong-sni
      description: Assert that the KongSNI resource is created for the SNI hostname.
      use:
       template: ../../common/_step_templates/assert-kongSNI.yaml
      bindings:
       - name: resource_type
         value: "kongcertificates.configuration.konghq.com"
  
    # Step 9: Create the httpbin service that will receive the routed traffic.
    - name: Create-httpbin-service
      description: Create and assert the httpbin service to route traffic to.
      use:
        template: ../../common/_step_templates/apply-assert-httpbinService.yaml

    # Step 10: Create the HTTPRoute with the RequestHeaderModifier filter.
    - name: Create-httproute-with-request-header-modifier
      description: Create HTTPRoute with RequestHeaderModifier filter.
      try:
        - apply:
            file: 01-httproute-filter-request-header-modifier.yaml
        - assert:
            file: 02-httproute-filter-request-header-modifier-assert.yaml
      bindings:
        - name: route_hosts
          value: 
            - ($fqdn)
    # Step 11: Assert that the HTTPRoute is translated into a KongRoute resource (RequestHeaderModifier).
    - name: Assert-kong-route-request-header-modifier
      description: Assert that the KongRoute resource is created for the HTTPRoute with RequestHeaderModifier.
      use:
        template: ../../common/_step_templates/assert-kongRoute.yaml
      bindings:
        - name: route_hosts
          value: ($fqdn)
        - name: route_paths
          value: 
            - "~/get$"
            - "/get/"
            - "~/post$"
            - "~/put$"
            - "~/patch$"
            - "~/delete$"
            - "~/status$"
            - "/status/"
        - name: route_methods
          value:
            - "GET"
            - "POST"
            - "PUT"
            - "PATCH"
            - "DELETE"
        - name: strip_path
          value: false
        - name: resource_type
          value: "kongservices.configuration.konghq.com"
    
    # Step 12: Assert that the HTTPRoute backend is translated into a KongService resource (RequestHeaderModifier).
    - name: Assert-kong-service-request-header-modifier
      description: Assert that the KongService resource is created for the HTTPRoute with RequestHeaderModifier.
      use:
        template: ../../common/_step_templates/assert-kongService.yaml

    # Step 13: Assert that the HTTPRoute backend is translated into a KongUpstream resource (RequestHeaderModifier).
    - name: Assert-kong-upstream-request-header-modifier
      description: Assert that the KongUpstream resource is created for the HTTPRoute with RequestHeaderModifier.
      use:
        template: ../../common/_step_templates/assert-kongUpstream.yaml
    
    # Step 14: Assert that the KongUpstream has KongTarget resources created for it (RequestHeaderModifier).
    - name: Assert-kong-target-request-header-modifier
      description: Assert that the KongTarget resource is created for the KongUpstream (RequestHeaderModifier).
      use:
        template: ../../common/_step_templates/assert-kongTarget.yaml
      bindings:
        - name: resource_type
          value: "kongupstreams.configuration.konghq.com"
        - name: target_weight
          value: 1
    
    # Step 15: Assert that the Request Transformer plugin is created with the expected configuration (RequestHeaderModifier).
    - name: Assert-Request-Transformer-Plugin-for-RequestHeaderModifier
      description: Assert that the Request Transformer plugin is created with the expected configuration (RequestHeaderModifier).
      use:
        template: ../../common/_step_templates/assert-kongPlugin.yaml
      bindings:
        - name: namespace
          value: ($namespace)
        - name: gateway_name
          value: ($gateway_name)
        - name: plugin_type
          value: request-transformer
        - name: plugin_config
          # Use '|' to handle the JSON string properly without quote conflicts
          value: '{"add":{"headers":["X-Set:foo"]},"append":{"headers":["X-Add:bar"]},"remove":{"headers":["X-Remove"]},"replace":{"headers":["X-Set:foo"]}}'
   
    # Step 16: Assert that the KongPluginBinding resource is created to bind the plugin to the route (RequestHeaderModifier).
    - name: Assert-KongPluginBinding-for-Request-Transformer-Plugin-RequestHeaderModifier
      description: Assert that the KongPluginBinding resource is created to bind the request transformer plugin to the route (RequestHeaderModifier).
      use:
        template: ../../common/_step_templates/assert-kongPluginBinding.yaml
  
    # Step 17: Test GET /get endpoint from the host (RequestHeaderModifier).
    - name: Verify-GET-traffic-from-host-request-header-modifier
      description: Verify that GET requests to /get work from the host (RequestHeaderModifier).
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    
    # Step 18: Test GET /get endpoint from the host via HTTPS (RequestHeaderModifier).
    - name: Verify-GET-HTTPS-traffic-from-host-request-header-modifier
      description: Verify that GET requests to /get work from the host via HTTPS (RequestHeaderModifier).
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: insecure
          value: "true"
    # Step 19: Test GET /get endpoint from within the cluster (RequestHeaderModifier).
    - name: Verify-GET-traffic-from-cluster-request-header-modifier
      description: Verify that GET requests to /get work from within the cluster (RequestHeaderModifier).
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn)
    # Step 20: Test GET /get endpoint from within the cluster via HTTPS (RequestHeaderModifier).
    - name: Verify-GET-HTTPS-traffic-from-cluster-request-header-modifier
      description: Verify that GET requests to /get work from within the cluster via HTTPS (RequestHeaderModifier).
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-cluster.yaml
      bindings:
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: insecure
          value: "true"

    # Step 21: Validate the RequestHeaderModifier filter over HTTP.
    - name: Verify-request-header-modifier-over-http
      description: Validate that the RequestHeaderModifier filter modifies headers correctly over HTTP.
      use:
        template: ../../common/_step_templates/verify-request-header-modifier.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name)
        - name: gateway_namespace
          value: ($gateway_namespace)
        - name: route_path
          value: "/get"
        - name: namespace
          value: ($http_route_namespace)
        - name: host_header
          value: ($fqdn)
        - name: proxy_port
          value: "80"
        - name: headers_to_send
          value: "X-Remove:to-be-removed,X-Set:existing-value"
        - name: expected_headers_present
          value: "X-Set:foo,X-Add:bar"
        - name: expected_headers_absent
          value: "X-Remove,X-Set:existing-value"
        - name: protocol
          value: "http"
        - name: insecure
          value: "false"

    # Step 22: Validate the RequestHeaderModifier filter over HTTPS.
    - name: Verify-request-header-modifier-over-https
      description: Validate that the RequestHeaderModifier filter modifies headers correctly over HTTPS.
      use:
        template: ../../common/_step_templates/verify-request-header-modifier.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name)
        - name: gateway_namespace 
          value: ($gateway_namespace)
        - name: route_path
          value: "/get"
        - name: namespace
          value: ($http_route_namespace)
        - name: host_header
          value: ($fqdn)
        - name: proxy_port
          value: "443"
        - name: headers_to_send
          value: "X-Remove:to-be-removed,X-Set:existing-value"
        - name: expected_headers_present
          value: "X-Set:foo,X-Add:bar"
        - name: expected_headers_absent
          value: "X-Remove,X-Set:existing-value"
        - name: protocol
          value: "https"
        - name: insecure
          value: "true"

    # Step 23: Create the HTTPRoute with the ResponseHeaderModifier filter.
    - name: Create-httproute-with-response-header-modifier
      description: Create HTTPRoute with ResponseHeaderModifier filter.
      try:
        - apply:
            file: 03-httproute-filter-response-header-modifier.yaml
        - assert:
            file: 04-httproute-filter-response-header-modifier-assert.yaml
      bindings:
        - name: http_route_name
          value: (join('-', [($test_name), 'httpbin-response-header-modifier']))
        - name: http_route_namespace
          value: ($namespace)
        - name: route_hosts
          value: 
            - ($response_filter_fqdn)
    # Step 24: Assert that the HTTPRoute is translated into a KongRoute resource (ResponseHeaderModifier).
    - name: Assert-kong-route-response-header-modifier
      description: Assert that the KongRoute resource is created for the HTTPRoute with ResponseHeaderModifier.
      use:
        template: ../../common/_step_templates/assert-kongRoute.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_response_filter_name)
        - name: http_route_namespace
          value: ($http_route_response_filter_namespace)
        - name: route_hosts
          value: ($response_filter_fqdn)
        - name: route_paths
          value: 
            - "~/get$"
        - name: route_methods
          value:
            - "GET"
        - name: strip_path
          value: false
        - name: resource_type
          value: "kongservices.configuration.konghq.com"
    
    # Step 25: Assert that the HTTPRoute backend is translated into a KongService resource (ResponseHeaderModifier).
    - name: Assert-kong-service-response-header-modifier
      description: Assert that the KongService resource is created for the HTTPRoute with ResponseHeaderModifier.
      use:
        template: ../../common/_step_templates/assert-kongService.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_response_filter_name)
        - name: http_route_namespace
          value: ($http_route_response_filter_namespace)

    # Step 26: Assert that the HTTPRoute backend is translated into a KongUpstream resource (ResponseHeaderModifier).
    - name: Assert-kong-upstream-response-header-modifier
      description: Assert that the KongUpstream resource is created for the HTTPRoute with ResponseHeaderModifier.
      use:
        template: ../../common/_step_templates/assert-kongUpstream.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_response_filter_name)
        - name: http_route_namespace
          value: ($http_route_response_filter_namespace)
    
    # Step 27: Assert that the KongUpstream has KongTarget resources created for it (ResponseHeaderModifier).
    - name: Assert-kong-target-response-header-modifier
      description: Assert that the KongTarget resource is created for the KongUpstream (ResponseHeaderModifier).
      use:
        template: ../../common/_step_templates/assert-kongTarget.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_response_filter_name)
        - name: http_route_namespace
          value: ($http_route_response_filter_namespace)
        - name: resource_type
          value: "kongupstreams.configuration.konghq.com"
        - name: target_weight
          value: 1

    # Step 28: Assert that the Response Transformer plugin is created with the expected configuration (ResponseHeaderModifier).
    - name: Assert-Response-Transformer-Plugin
      description: Assert that the Response Transformer plugin is created with the expected configuration (ResponseHeaderModifier).
      use:
        template: ../../common/_step_templates/assert-kongPlugin.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_response_filter_name)
        - name: http_route_namespace
          value: ($http_route_response_filter_namespace)
        - name: namespace
          value: ($namespace)
        - name: gateway_name
          value: ($gateway_name)
        - name: plugin_type
          value: response-transformer
        - name: plugin_config
          # Use '|' to handle the JSON string properly without quote conflicts
          value: '{"add":{"headers":["X-Set-Response:foo"]},"append":{"headers":["X-Add-Response:bar"]},"remove":{"headers":["X-Remove-Response"]},"replace":{"headers":["X-Set-Response:foo"]}}'
   
    # Step 29: Assert that the KongPluginBinding resource is created to bind the plugin to the route (ResponseHeaderModifier).
    - name: Assert-KongPluginBinding-for-Response-Transformer-Plugin
      description: Assert that the KongPluginBinding resource is created to bind the response transformer plugin to the route (ResponseHeaderModifier).
      use:
        template: ../../common/_step_templates/assert-kongPluginBinding.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_response_filter_name)
        - name: http_route_namespace
          value: ($http_route_response_filter_namespace)
      
  
    # Step 30: Test GET /get endpoint from the host (ResponseHeaderModifier).
    - name: Verify-GET-traffic-from-host-response-header-modifier
      description: Verify that GET requests to /get work from the host (ResponseHeaderModifier).
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_response_filter_name)
        - name: http_route_namespace
          value: ($http_route_response_filter_namespace)
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($response_filter_fqdn)
    
    # Step 31: Test GET /get endpoint from the host via HTTPS (ResponseHeaderModifier).
    - name: Verify-GET-HTTPS-traffic-from-host-response-header-modifier
      description: Verify that GET requests to /get work from the host via HTTPS (ResponseHeaderModifier).
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_response_filter_name)
        - name: http_route_namespace
          value: ($http_route_response_filter_namespace)
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: insecure
          value: "true"
        - name: fqdn
          value: ($response_filter_fqdn)

    # Step 32: Test GET /get endpoint from within the cluster (ResponseHeaderModifier).
    - name: Verify-GET-traffic-from-cluster-response-header-modifier
      description: Verify that GET requests to /get work from within the cluster (ResponseHeaderModifier).
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-cluster.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_response_filter_name)
        - name: http_route_namespace
          value: ($http_route_response_filter_namespace)
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($response_filter_fqdn)

    # Step 33: Test GET /get endpoint from within the cluster via HTTPS (ResponseHeaderModifier).
    - name: Verify-GET-HTTPS-traffic-from-cluster-response-header-modifier
      description: Verify that GET requests to /get work from within the cluster via HTTPS (ResponseHeaderModifier).
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-cluster.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_response_filter_name)
        - name: http_route_namespace
          value: ($http_route_response_filter_namespace)
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: insecure
          value: "true"
        - name: fqdn
          value: ($response_filter_fqdn)

    # Step 34: Validate the ResponseHeaderModifier filter over HTTP.
    - name: Verify-response-header-modifier-over-http
      description: Validate that the ResponseHeaderModifier filter modifies headers correctly over HTTP.
      use:
        template: ../../common/_step_templates/verify-response-header-modifier.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name)
        - name: gateway_namespace
          value: ($gateway_namespace)
        - name: route_path
          value: "/get"
        - name: namespace
          value: ($http_route_namespace)
        - name: host_header
          value: ($response_filter_fqdn)
        - name: proxy_port
          value: "80"
        - name: headers_to_send
          value: "X-Remove-Response:to-be-removed,X-Set-Response:existing-value"
        - name: expected_headers_present
          value: "X-Set-Response:foo,X-Add-Response:bar"
        - name: expected_headers_absent
          value: "X-Remove-Response,X-Set-Response:existing-value"
        - name: protocol
          value: "http"
        - name: insecure
          value: "false"

    # Step 35: Validate the ResponseHeaderModifier filter over HTTPS.
    - name: Verify-response-header-modifier-over-https
      description: Validate that the ResponseHeaderModifier filter modifies headers correctly over HTTPS.
      use:
        template: ../../common/_step_templates/verify-response-header-modifier.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name)
        - name: gateway_namespace 
          value: ($gateway_namespace)
        - name: route_path
          value: "/get"
        - name: namespace
          value: ($http_route_namespace)
        - name: host_header
          value: ($response_filter_fqdn)
        - name: proxy_port
          value: "443"
        - name: headers_to_send
          value: "X-Remove-Response:to-be-removed,X-Set-Response:existing-value"
        - name: expected_headers_present
          value: "X-Set-Response:foo,X-Add-Response:bar"
        - name: expected_headers_absent
          value: "X-Remove-Response,X-Set-Response:existing-value"
        - name: protocol
          value: "https"
        - name: insecure
          value: "true"

    # Step 36: Create the HTTPRoute with combined filters (RequestHeaderModifier and ResponseHeaderModifier).
    - name: Create-httproute-with-combined-filters
      description: Create HTTPRoute with both RequestHeaderModifier and ResponseHeaderModifier filters.
      try:
        - apply:
            file: 05-httproute-filter-combined-filters.yaml
        - assert:
            file: 06-httproute-filter-combined-filters-assert.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_combined_filters_name)
        - name: http_route_namespace
          value: ($http_route_combined_filters_namespace)
        - name: route_hosts
          value: 
            - ($combined_filters_fqdn)

    # Step 37: Assert that the HTTPRoute is translated into a KongRoute resource (combined filters).
    - name: Assert-kong-route-combined-filters
      description: Assert that the KongRoute resource is created for the HTTPRoute with combined filters.
      use:
        template: ../../common/_step_templates/assert-kongRoute.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_combined_filters_name)
        - name: http_route_namespace
          value: ($http_route_combined_filters_namespace)
        - name: route_hosts
          value: ($combined_filters_fqdn)
        - name: route_paths
          value: 
            - "~/get$"
        - name: route_methods
          value:
            - "GET"
        - name: strip_path
          value: false
        - name: resource_type
          value: "kongservices.configuration.konghq.com"
    
    # Step 38: Assert that the HTTPRoute backend is translated into a KongService resource (combined filters).
    - name: Assert-kong-service-combined-filters
      description: Assert that the KongService resource is created for the HTTPRoute with combined filters.
      use:
        template: ../../common/_step_templates/assert-kongService.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_combined_filters_name)
        - name: http_route_namespace
          value: ($http_route_combined_filters_namespace)

    # Step 39: Assert that the HTTPRoute backend is translated into a KongUpstream resource (combined filters).
    - name: Assert-kong-upstream-combined-filters
      description: Assert that the KongUpstream resource is created for the HTTPRoute with combined filters.
      use:
        template: ../../common/_step_templates/assert-kongUpstream.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_combined_filters_name)
        - name: http_route_namespace
          value: ($http_route_combined_filters_namespace)
    
    # Step 40: Assert that the KongUpstream has KongTarget resources created for it (combined filters).
    - name: Assert-kong-target-combined-filters
      description: Assert that the KongTarget resource is created for the KongUpstream (combined filters).
      use:
        template: ../../common/_step_templates/assert-kongTarget.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_combined_filters_name)
        - name: http_route_namespace
          value: ($http_route_combined_filters_namespace)
        - name: resource_type
          value: "kongupstreams.configuration.konghq.com"
        - name: target_weight
          value: 1

    # Step 41: Assert that the Request Transformer plugin is created with the expected configuration (combined filters).
    - name: Assert-Request-Transformer-Plugin-for-Combined-Filters
      description: Assert that the Request Transformer plugin is created with the expected configuration (combined filters).
      use:
        template: ../../common/_step_templates/assert-kongPlugin.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_combined_filters_name)
        - name: http_route_namespace
          value: ($http_route_combined_filters_namespace)
        - name: namespace
          value: ($namespace)
        - name: gateway_name
          value: ($gateway_name)
        - name: plugin_type
          value: request-transformer
        - name: plugin_config
          value: '{"add":{"headers":["X-Request-Set:request-foo"]},"append":{"headers":["X-Request-Add:request-bar"]},"remove":{"headers":["X-Request-Remove"]},"replace":{"headers":["X-Request-Set:request-foo"]}}'
   
    # Step 42: Assert that the Response Transformer plugin is created with the expected configuration (combined filters).
    - name: Assert-Response-Transformer-Plugin-for-Combined-Filters
      description: Assert that the Response Transformer plugin is created with the expected configuration (combined filters).
      use:
        template: ../../common/_step_templates/assert-kongPlugin.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_combined_filters_name)
        - name: http_route_namespace
          value: ($http_route_combined_filters_namespace)
        - name: namespace
          value: ($namespace)
        - name: gateway_name
          value: ($gateway_name)
        - name: plugin_type
          value: response-transformer
        - name: plugin_config
          value: '{"add":{"headers":["X-Response-Set:response-foo"]},"append":{"headers":["X-Response-Add:response-bar"]},"remove":{"headers":["X-Response-Remove"]},"replace":{"headers":["X-Response-Set:response-foo"]}}'
   
    # Step 43: Assert that the KongPluginBinding resources are created to bind both plugins to the route (combined filters).
    - name: Assert-KongPluginBinding-for-Combined-Filters
      description: Assert that the KongPluginBinding resources are created to bind both transformer plugins to the route (combined filters).
      use:
        template: ../../common/_step_templates/assert-kongPluginBinding.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_combined_filters_name)
        - name: http_route_namespace
          value: ($http_route_combined_filters_namespace)
  
    # Step 44: Verify GET /get endpoint from the host (combined filters).
    - name: Verify-GET-traffic-from-host-combined-filters
      description: Verify that GET requests to /get work from the host (combined filters).
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_combined_filters_name)
        - name: http_route_namespace
          value: ($http_route_combined_filters_namespace)
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($combined_filters_fqdn)
    
    # Step 45: Verify GET /get endpoint from the host via HTTPS (combined filters).
    - name: Verify-GET-HTTPS-traffic-from-host-combined-filters
      description: Verify that GET requests to /get work from the host via HTTPS (combined filters).
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: http_route_name
          value: ($http_route_combined_filters_name)
        - name: http_route_namespace
          value: ($http_route_combined_filters_namespace)
        - name: route_path
          value: "/get"
        - name: http_method
          value: "GET"
        - name: insecure
          value: "true"
        - name: fqdn
          value: ($combined_filters_fqdn)

    # Step 46: Validate the RequestHeaderModifier filter in combined filters over HTTP.
    - name: Verify-request-header-modifier-combined-filters-over-http
      description: Validate that the RequestHeaderModifier filter modifies headers correctly in combined filters over HTTP.
      use:
        template: ../../common/_step_templates/verify-request-header-modifier.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name)
        - name: gateway_namespace
          value: ($gateway_namespace)
        - name: route_path
          value: "/get"
        - name: namespace
          value: ($http_route_combined_filters_namespace)
        - name: host_header
          value: ($combined_filters_fqdn)
        - name: proxy_port
          value: "80"
        - name: headers_to_send
          value: "X-Request-Remove:to-be-removed,X-Request-Set:existing-value"
        - name: expected_headers_present
          value: "X-Request-Set:request-foo,X-Request-Add:request-bar"
        - name: expected_headers_absent
          value: "X-Request-Remove,X-Request-Set:existing-value"
        - name: protocol
          value: "http"
        - name: insecure
          value: "false"

    # Step 47: Validate the ResponseHeaderModifier filter in combined filters over HTTP.
    - name: Verify-response-header-modifier-combined-filters-over-http
      description: Validate that the ResponseHeaderModifier filter modifies headers correctly in combined filters over HTTP.
      use:
        template: ../../common/_step_templates/verify-response-header-modifier.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name)
        - name: gateway_namespace
          value: ($gateway_namespace)
        - name: route_path
          value: "/get"
        - name: namespace
          value: ($http_route_combined_filters_namespace)
        - name: host_header
          value: ($combined_filters_fqdn)
        - name: proxy_port
          value: "80"
        - name: headers_to_send
          value: "X-Response-Remove:to-be-removed,X-Response-Set:existing-value"
        - name: expected_headers_present
          value: "X-Response-Set:response-foo,X-Response-Add:response-bar"
        - name: expected_headers_absent
          value: "X-Response-Remove,X-Response-Set:existing-value"
        - name: protocol
          value: "http"
        - name: insecure
          value: "false"

    # Step 48: Validate the RequestHeaderModifier filter in combined filters over HTTPS.
    - name: Verify-request-header-modifier-combined-filters-over-https
      description: Validate that the RequestHeaderModifier filter modifies headers correctly in combined filters over HTTPS.
      use:
        template: ../../common/_step_templates/verify-request-header-modifier.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name)
        - name: gateway_namespace 
          value: ($gateway_namespace)
        - name: route_path
          value: "/get"
        - name: namespace
          value: ($http_route_combined_filters_namespace)
        - name: host_header
          value: ($combined_filters_fqdn)
        - name: proxy_port
          value: "443"
        - name: headers_to_send
          value: "X-Request-Remove:to-be-removed,X-Request-Set:existing-value"
        - name: expected_headers_present
          value: "X-Request-Set:request-foo,X-Request-Add:request-bar"
        - name: expected_headers_absent
          value: "X-Request-Remove,X-Request-Set:existing-value"
        - name: protocol
          value: "https"
        - name: insecure
          value: "true"

    # Step 49: Validate the ResponseHeaderModifier filter in combined filters over HTTPS.
    - name: Verify-response-header-modifier-combined-filters-over-https
      description: Validate that the ResponseHeaderModifier filter modifies headers correctly in combined filters over HTTPS.
      use:
        template: ../../common/_step_templates/verify-response-header-modifier.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name)
        - name: gateway_namespace 
          value: ($gateway_namespace)
        - name: route_path
          value: "/get"
        - name: namespace
          value: ($http_route_combined_filters_namespace)
        - name: host_header
          value: ($combined_filters_fqdn)
        - name: proxy_port
          value: "443"
        - name: headers_to_send
          value: "X-Response-Remove:to-be-removed,X-Response-Set:existing-value"
        - name: expected_headers_present
          value: "X-Response-Set:response-foo,X-Response-Add:response-bar"
        - name: expected_headers_absent
          value: "X-Response-Remove,X-Response-Set:existing-value"
        - name: protocol
          value: "https"
        - name: insecure
          value: "true"

  catch:
    # Capture debug snapshot on test failure for CI debugging.
    - description: Capture debug snapshot
      script:
        env:
          - name: TEST_NAME
            value: hybridgateway-httproute-filters
          - name: NAMESPACE
            value: ($namespace)
          - name: OPERATOR_NAMESPACE
            value: kong-system
        content: |
          bash ../../common/scripts/debug_snapshot.sh
