---
# Template for asserting KongTarget resources
#
# Required bindings:
#   - namespace: Resource namespace (e.g., "kong")
#   - managedby_name: HTTPRoute name (e.g., "echo")
#   - managedby_namespace: HTTPRoute namespace (e.g., "kong")
#   - hybrid_gateway_name: Gateway name (e.g., "kong-foo")
#   - hybrid_gateway_namespace: Gateway namespace (e.g., "kong")
#   - weight: Target weight (e.g., 1)
#   - kongupstream_name: Name of the KongUpstream this target references
apiVersion: configuration.konghq.com/v1alpha1
kind: KongTarget
metadata:
  namespace: ($namespace)
  (labels."gateway-operator.konghq.com/managed-by" == 'HTTPRoute'): true
  (annotations."gateway-operator.konghq.com/hybrid-routes" | contains(@, join('/', [($managedby_namespace), ($managedby_name)]))): true
spec:
  weight: ($weight)
  upstreamRef:
    name: ($kongupstream_name)
  # Assert target field is populated with IP:port
  (target != null): true
status:
  # Filter conditions to check for required status
  (conditions[?type == 'Programmed']):
    - status: 'True'
      reason: Programmed
  (conditions[?type == 'KongUpstreamRefValid']):
    - status: 'True'
      reason: Valid
  (conditions[?type == 'ControlPlaneRefValid']):
    - status: 'True'
      reason: Valid
  (conditions[?type == 'APIAuthResolvedRef']):
    - status: 'True'
      reason: ResolvedRef
  (conditions[?type == 'APIAuthValid']):
    - status: 'True'
      reason: Valid
  # Assert Konnect integration fields are populated
  (konnect.controlPlaneID != null): true
  (konnect.id != null): true
  (konnect.upstreamID != null): true
