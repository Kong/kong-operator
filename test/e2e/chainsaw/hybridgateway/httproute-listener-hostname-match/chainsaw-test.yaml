# Gateway with listener hostnames test scenario
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: "httproute-listener-hostname-match"
spec:
  description: |
    This test validates that the hybrid gateway controller correctly
    processes the hostname specified in listener of Gateway. The
    hostname of listener should be translated to hostname matches
    in the routes when the HTTPRoute references the listener as its parent.
    This test covers both HTTP and HTTPS protocols.

  bindings:
    - name: test_name
      value: ($namespace)
    - name: namespace
      value: ($namespace)
    - name: konnect_api_auth_name
      value: konnect-api-auth-dev-1
    - name: konnect_token
      value: (env('KONNECT_TOKEN'))
    - name: konnect_url
      value: (env('KONNECT_SERVER_URL') || 'eu.api.konghq.tech')
    - name: auth_secret_name
      value: (join('-', [($test_name), 'konnect-auth-secret']))
    - name: auth_secret_namespace
      value: ($namespace)
    - name: konnect_auth_name
      value: (join('-', [($test_name), 'konnect-api-auth']))
    - name: konnect_auth_namespace
      value: ($namespace)
    - name: gateway_image
      value: (env('GATEWAY_IMAGE') || 'kong/kong-gateway:3.12')
    - name: gateway_class_name
      value: (join('-', [($test_name), 'gateway-class']))
    - name: gateway_configuration_name
      value: (join('-', [($test_name), 'gateway-configuration']))
    - name: gateway_namespace
      value: ($namespace)
    - name: gateway_name_wildcard_listener
      value: (join('-', [($namespace), 'wildcard-listener']))
    - name: gateway_name_exact_listener
      value: (join('-', [($namespace), 'exact-listener']))
    - name: http_route_namespace
      value: ($namespace)
    - name: httpbin_service_name
      value: httpbin
    - name: httpbin_service_namespace
      value: ($namespace)
    - name: httpbin_deployment_name
      value: httpbin
    - name: httpbin_deployment_namespace
      value: ($namespace)
    - name: httpbin_service_port
      value: 80
    - name: listener_http_port
      value: 80
    - name: listener_https_port
      value: 443
    - name: http_method
      value: "GET"
    - name: insecure
      value: "true"
    - name: request_headers
      value: ""

    # Unique HTTPRoute names
    - name: httproute_name_wildcard
      value: (join('-', [($namespace), 'wildcard']))
    - name: httproute_name_exact
      value: (join('-', [($namespace), 'exact']))
    - name: httproute_name_exact_listener
      value: (join('-', [($namespace), 'exact-listener']))
    - name: httproute_name_partial_wildcard
      value: (join('-', [($namespace), 'partial-wildcard']))
    - name: httproute_name_partial_exact
      value: (join('-', [($namespace), 'partial-exact']))

    # TLS configuration for wildcard listener
    - name: cert_secret_name_wildcard
      value: tls-wildcard-httpbin-test
    - name: listener_http_hostname_wildcard
      value: "*.http.httpbin.test"
    - name: listener_https_hostname_wildcard
      value: "*.https.httpbin.test"
    - name: sni_hostname_wildcard
      value: ($listener_https_hostname_wildcard)

    # Test hostnames for wildcard listener
    - name: test_hostname_foo_http
      value: "foo.http.httpbin.test"
    - name: test_hostname_bar_http
      value: "bar.http.httpbin.test"
    - name: test_hostname_foo_https
      value: "foo.https.httpbin.test"
    - name: test_hostname_bar_https
      value: "bar.https.httpbin.test"
    - name: test_hostname_nomatch_http
      value: "foo.httpbin-1.test"
    - name: test_hostname_exact_http
      value: "exact.http.httpbin.test"
    - name: test_hostname_exact_https
      value: "exact.https.httpbin.test"

    # TLS configuration for exact listener
    - name: cert_secret_name_exact
      value: tls-exact-httpbin-2-test
    - name: listener_http_hostname_exact
      value: "exact.http.httpbin-2.test"
    - name: listener_https_hostname_exact
      value: "exact.https.httpbin-2.test"
    - name: sni_hostname_exact
      value: ($listener_https_hostname_exact)
      
    # Test hostnames for exact listener
    - name: test_hostname_exact_listener_http
      value: "exact.http.httpbin-2.test"
    - name: test_hostname_exact_listener_https
      value: "exact.https.httpbin-2.test"

  steps:
  # Step 1: Create test namespace.
  - name: 1-create-namespace
    description: Create namespace for test resources
    use:
      template: ../../common/_step_templates/apply-assert-namespace.yaml
    bindings:
      - name: namespace_name
        value: ($namespace)

  # Step 2a: Create the secret for Konnect authentication.
  - name: Create-auth-secret
    description: Create Secret with Konnect token for KonnectAPIAuthConfiguration.
    use:
      template: ../../common/_step_templates/apply-assert-konnectAuthSecret.yaml

  # Step 2b: Create KonnectAPIAuthConfiguration.
  - name: 2-create-konnect-api-auth
    description: Create KonnectAPIAuthConfiguration for the test
    use:
      template: ../../common/_step_templates/apply-assert-konnectAPIAuthConfiguration-secretref.yaml

  # Step 3: Create GatewayConfiguration.
  - name: 3-create-gateway-configuration
    description: Create GatewayConfiguration for the test
    use:
      template: ../../common/_step_templates/apply-assert-gatewayConfiguration.yaml

  # Step 4: Create GatewayClass.
  - name: 4-create-gateway-class
    description: Create GatewayClass for the test
    use:
      template: ../../common/_step_templates/apply-assert-gatewayClass.yaml

  # Step 5: Create httpbin service.
  - name: 5-create-httpbin-service
    description: Create httpbin service for backend
    use:
      template: ../../common/_step_templates/apply-assert-httpbinService.yaml

  # Step 6a: Create TLS secret for wildcard listener gateway.
  - name: 6a-create-tls-secret-wildcard
    description: Create TLS secret for wildcard listener gateway
    use:
      template: ../../common/_step_templates/apply-assert-tlsSecret.yaml
    bindings:
      - name: sni_hostname
        value: ($sni_hostname_wildcard)
      - name: cert_secret_name
        value: ($cert_secret_name_wildcard)
      - name: cert_secret_namespace
        value: ($namespace)

  # Step 6b: Create Gateway with wildcard listener hostname (HTTP and HTTPS).
  - name: 6b-create-gateway-wildcard-listener
    description: Create Gateway with wildcard listener hostname for both HTTP and HTTPS
    try:
      - apply:
          file: 06-gateway-wildcard-listener.yaml
      - assert:
          file: 06-assert-gateway-wildcard-listener.yaml

  # Step 6c: Create HTTPRoute with wildcard hostname.
  - name: 6c-create-httproute-wildcard-hostname
    description: Create HTTPRoute with wildcard hostname
    bindings:
      - name: httproute_name
        value: ($httproute_name_wildcard)
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/"
    try:
      - apply:
          file: 07-httproute-wildcard-hostname.yaml
      - assert:
          file: 07-assert-httproute-wildcard-hostname.yaml

  # Step 6d: Test wildcard hostname matching with HTTP (foo.http.httpbin.test).
  - name: 6d-test-wildcard-hostname-http-foo
    description: Test that foo.http.httpbin.test matches wildcard listener via HTTP
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/get"
      - name: host_header
        value: ($test_hostname_foo_http)
      - name: expected_status
        value: "200"

  # Step 6e: Test wildcard hostname matching with HTTP (bar.http.httpbin.test).
  - name: 6e-test-wildcard-hostname-http-bar
    description: Test that bar.http.httpbin.test matches wildcard listener via HTTP
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/get"
      - name: host_header
        value: ($test_hostname_bar_http)
      - name: expected_status
        value: "200"

  # Step 6f: Test wildcard hostname matching with HTTPS (foo.https.httpbin.test).
  - name: 6f-test-wildcard-hostname-https-foo
    description: Test that foo.https.httpbin.test matches wildcard listener via HTTPS
    use:
      template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: fqdn
        value: ($test_hostname_foo_https)
      - name: route_path
        value: "/get"

  # Step 6g: Test wildcard hostname matching with HTTPS (bar.https.httpbin.test).
  - name: 6g-test-wildcard-hostname-https-bar
    description: Test that bar.https.httpbin.test matches wildcard listener via HTTPS
    use:
      template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: fqdn
        value: ($test_hostname_bar_https)
      - name: route_path
        value: "/get"

  # Step 6h: Test non-matching hostname returns 404 via HTTP.
  - name: 6h-test-wildcard-hostname-http-no-match
    description: Test that foo.httpbin-1.test does NOT match wildcard listener via HTTP
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/get"
      - name: host_header
        value: "foo.httpbin-1.test"
      - name: expected_status
        value: "404"

  # Step 6i: Test request without hostname returns 404 via HTTP.
  - name: 6i-test-wildcard-hostname-http-no-host
    description: Test that request without Host header returns 404 via HTTP
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/get"
      - name: host_header
        value: ""
      - name: expected_status
        value: "404"

  # Step 7a: Create HTTPRoute with exact hostname attached to wildcard listener.
  - name: 7a-create-httproute-exact-hostname
    description: Create HTTPRoute with exact hostname attached to gateway with wildcard listener
    bindings:
      - name: httproute_name
        value: ($httproute_name_exact)
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/"
    try:
      - apply:
          file: 08-httproute-exact-hostname.yaml
      - assert:
          file: 08-assert-httproute-exact-hostname.yaml

  # Step 7b: Test exact hostname matching via HTTP.
  - name: 7b-test-exact-hostname-http
    description: Test that exact.http.httpbin.test matches via HTTP
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/post"
      - name: http_method
        value: "POST"
      - name: host_header
        value: ($test_hostname_exact_http)
      - name: expected_status
        value: "200"

  # Step 7c: Test exact hostname matching via HTTPS.
  - name: 7c-test-exact-hostname-https
    description: Test that exact.https.httpbin.test matches via HTTPS
    use:
      template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: fqdn
        value: ($test_hostname_exact_https)
      - name: http_method
        value: "POST"
      - name: route_path
        value: "/post"

  # Step 7d: Test non-matching hostname returns 404 via HTTP.
  - name: 7d-test-exact-hostname-http-no-match
    description: Test that not-exact.http.httpbin.test does NOT match via HTTP
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/post"
      - name: http_method
        value: "POST"
      - name: host_header
        value: "not-exact.http.httpbin.test"
      - name: expected_status
        value: "404"

  # Step 8a: Create TLS secret for exact listener gateway.
  - name: 8a-create-tls-secret-exact
    description: Create TLS secret for exact listener gateway
    use:
      template: ../../common/_step_templates/apply-assert-tlsSecret.yaml
    bindings:
      - name: sni_hostname
        value: ($sni_hostname_exact)
      - name: cert_secret_name
        value: ($cert_secret_name_exact)
      - name: cert_secret_namespace
        value: ($namespace)

  # Step 8b: Create Gateway with exact listener hostname (HTTP and HTTPS).
  - name: 8b-create-gateway-exact-listener
    description: Create Gateway with exact listener hostname for both HTTP and HTTPS
    try:
      - apply:
          file: 09-gateway-exact-listener.yaml
      - assert:
          file: 09-assert-gateway-exact-listener.yaml

  # Step 8c: Create HTTPRoute attached to gateway with exact listener hostname.
  - name: 8c-create-httproute-exact-listener
    description: Create HTTPRoute attached to gateway with exact listener hostname
    bindings:
      - name: httproute_name
        value: ($httproute_name_exact_listener)
      - name: gateway_name
        value: ($gateway_name_exact_listener)
      - name: route_path
        value: "/"
    try:
      - apply:
          file: 10-httproute-exact-listener.yaml
      - assert:
          file: 10-assert-httproute-exact-listener.yaml

  # Step 8d: Test exact listener hostname matching via HTTP.
  - name: 8d-test-exact-listener-http
    description: Test that exact.http.httpbin-2.test matches exact listener via HTTP
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_exact_listener)
      - name: route_path
        value: "/put"
      - name: http_method
        value: "PUT"
      - name: host_header
        value: ($test_hostname_exact_listener_http)
      - name: expected_status
        value: "200"

  # Step 8e: Test exact listener hostname matching via HTTPS.
  - name: 8e-test-exact-listener-https
    description: Test that exact.https.httpbin-2.test matches exact listener via HTTPS
    use:
      template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_exact_listener)
      - name: fqdn
        value: ($test_hostname_exact_listener_https)
      - name: http_method
        value: "PUT"
      - name: route_path
        value: "/put"

  # Step 8f: Test non-matching hostname returns 404 via HTTP.
  - name: 8f-test-exact-listener-http-no-match
    description: Test that not-exact.http.httpbin-2.test does NOT match exact listener via HTTP
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_exact_listener)
      - name: route_path
        value: "/put"
      - name: http_method
        value: "PUT"
      - name: host_header
        value: "not-exact.http.httpbin-2.test"
      - name: expected_status
        value: "404"

  # Step 9a: Create HTTPRoute with partial wildcard hostname match.
  - name: 9a-create-httproute-partial-wildcard
    description: Create HTTPRoute where only some hostnames match the wildcard listener
    bindings:
      - name: httproute_name
        value: ($httproute_name_partial_wildcard)
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/"
    try:
      - apply:
          file: 11-httproute-partial-wildcard.yaml
      - assert:
          file: 11-assert-httproute-partial-wildcard.yaml

  # Step 9b: Test matching hostname from partial match via HTTP.
  - name: 9b-test-partial-wildcard-http-match-a
    description: Test that a.foo.http.httpbin.test matches (part of listener hostname)
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/delete"
      - name: http_method
        value: "DELETE"
      - name: host_header
        value: "a.foo.http.httpbin.test"
      - name: expected_status
        value: "200"

  # Step 9c: Test another matching hostname from partial match via HTTP.
  - name: 9c-test-partial-wildcard-http-match-b
    description: Test that b.foo.http.httpbin.test matches (part of listener hostname)
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/delete"
      - name: http_method
        value: "DELETE"
      - name: host_header
        value: "b.foo.http.httpbin.test"
      - name: expected_status
        value: "200"

  # Step 9d: Test matching hostname from partial match via HTTPS.
  - name: 9d-test-partial-wildcard-https-match
    description: Test that foo.https.httpbin.test matches via HTTPS
    use:
      template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: fqdn
        value: "foo.https.httpbin.test"
      - name: http_method
        value: "DELETE"
      - name: route_path
        value: "/delete"

  # Step 9e: Test non-matching hostname from HTTPRoute returns 404 via HTTP.
  - name: 9e-test-partial-wildcard-http-no-match
    description: Test that a.foo.http.httpbin.example does NOT match (not in listener hostname)
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/delete"
      - name: http_method
        value: "DELETE"
      - name: host_header
        value: "a.foo.http.httpbin.example"
      - name: expected_status
        value: "404"

  # Step 10a: Create HTTPRoute with partial exact hostname match.
  - name: 10a-create-httproute-partial-exact
    description: Create HTTPRoute where only some exact hostnames match the wildcard listener
    bindings:
      - name: httproute_name
        value: ($httproute_name_partial_exact)
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/"
    try:
      - apply:
          file: 12-httproute-partial-exact.yaml
      - assert:
          file: 12-assert-httproute-partial-exact.yaml

  # Step 10b: Test matching exact hostname from partial match via HTTP.
  - name: 10b-test-partial-exact-http-match
    description: Test that exact.http.httpbin.test matches (part of listener hostname)
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/patch"
      - name: http_method
        value: "PATCH"
      - name: host_header
        value: ($test_hostname_exact_http)
      - name: expected_status
        value: "200"

  # Step 10c: Test matching exact hostname from partial match via HTTPS.
  - name: 10c-test-partial-exact-https-match
    description: Test that exact.https.httpbin.test matches via HTTPS
    use:
      template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: fqdn
        value: ($test_hostname_exact_https)
      - name: http_method
        value: "PATCH"
      - name: route_path
        value: "/patch"

  # Step 10d: Test non-matching exact hostname from HTTPRoute returns 404 via HTTP.
  - name: 10d-test-partial-exact-http-no-match
    description: Test that exact.httpbin.example does NOT match (not in listener hostname)
    use:
      template: ../../common/_step_templates/verify-header-match-routing.yaml
    bindings:
      - name: gateway_name
        value: ($gateway_name_wildcard_listener)
      - name: route_path
        value: "/patch"
      - name: http_method
        value: "PATCH"
      - name: host_header
        value: "exact.httpbin.example"
      - name: expected_status
        value: "404"

  catch:
    # Capture debug snapshot on test failure for CI debugging.
    - description: Capture debug snapshot
      script:
        env:
          - name: TEST_NAME
            value: hybridgateway-httproute-listener-hostname-match
          - name: NAMESPACE
            value: ($namespace)
          - name: OPERATOR_NAMESPACE
            value: kong-system
        content: |
          bash ../../common/scripts/debug_snapshot.sh
