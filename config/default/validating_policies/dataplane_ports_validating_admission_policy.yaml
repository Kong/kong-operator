---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: ports.dataplane.gateway-operator.konghq.com
spec:
  matchConstraints:
    resourceRules:
      - apiGroups:
          - "gateway-operator.konghq.com"
        apiVersions:
          - "v1beta1"
        operations:
          - "CREATE"
          - "UPDATE"
        resources:
          - "dataplanes"
  variables:
    - name: ingressPorts
      expression: object.spec.network.services.ingress.ports
    - name: podTemplateSpec
      expression: object.spec.deployment.podTemplateSpec
    - name: proxyContainers
      expression: |
        variables.podTemplateSpec.spec.containers.filter(c, c.name == 'proxy')
    - name: proxyContainer
      expression: |
        variables.proxyContainers.size() > 0 ?
          variables.proxyContainers[0] :
          null
    - name: envFilteredPortMaps
      expression: |
        variables.proxyContainer != null && has(variables.proxyContainer.env) ?
          variables.proxyContainer.env.filter(e, e.name == "KONG_PORT_MAPS") : []
    - name: envFilteredProxyListen
      expression: |
        variables.proxyContainer != null && has(variables.proxyContainer.env) ?
          variables.proxyContainer.env.filter(e, e.name == "KONG_PROXY_LISTEN") : []
    - name: envPortMaps
      expression: |
        variables.envFilteredPortMaps.size() > 0 ? variables.envFilteredPortMaps[0].value : null
    - name: envProxyListen
      expression: |
        variables.envFilteredProxyListen.size() > 0 ? variables.envFilteredProxyListen[0].value : null

    # Helper variable to avoid duplicating the structural checks in every validation
    - name: isNotValidatable
      expression: |
        !has(object.spec.network) ||
        !has(object.spec.network.services) ||
        !has(object.spec.network.services.ingress) ||
        !has(object.spec.network.services.ingress.ports) ||
        variables.proxyContainer == null ||
        !has(variables.proxyContainer.env)

    # Pre-calculate the ports from KONG_PROXY_LISTEN to handle IPv4 (80:80) and IPv6 ([::]:80) correctly.
    # Logic:
    # 1. Split by comma to get entries (e.g. "0.0.0.0:8000 reuseport", "[::]:8000")
    # 2. Trim and take the first part (address:port)
    # 3. Find the last colon and take the substring after it to get the port
    - name: proxyListenPorts
      expression: |
        variables.envProxyListen != null ?
        variables.envProxyListen.split(',').map(s,
          s.trim().split(' ')[0]
        ).map(addr,
          addr.substring(addr.lastIndexOf(':') + 1)
        ) : []

    # Pre-calculate ports from KONG_PORT_MAPS for consistency
    - name: portMapPorts
      expression: |
        variables.envPortMaps != null ?
        variables.envPortMaps.split(',').map(s,
          s.split(':')[1].trim()
        ) : []

  # NOTE: Rules below do not validate the ports from the spec.network.services.ingress.ports
  # when no KONG_PORT_MAPS or KONG_PROXY_LISTEN env variables are present in the proxy container.
  # This has been the case before the introduction of validating admission policies so we are keeping
  # the same behavior.

  # Using string functions from: https://pkg.go.dev/github.com/google/cel-go/ext
  validations:
    - messageExpression: "'Each port from spec.network.services.ingress.ports has to have an accompanying port in KONG_PORT_MAPS env'"
      expression: |
        variables.isNotValidatable ||
        variables.envPortMaps == null ||
        variables.ingressPorts.all(p, string(p.targetPort) in variables.portMapPorts)
      reason: Invalid
    - messageExpression: "'Each port from spec.network.services.ingress.ports has to have an accompanying port in KONG_PROXY_LISTEN env'"
      expression: |
        variables.isNotValidatable ||
        variables.envProxyListen == null ||
        variables.ingressPorts.all(p, string(p.targetPort) in variables.proxyListenPorts)
      reason: Invalid
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: binding-ports.dataplane.gateway-operator.konghq.com
spec:
  policyName: ports.dataplane.gateway-operator.konghq.com
  validationActions:
    - Deny