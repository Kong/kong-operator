# HTTPRoute with Multiple ParentRefs test scenario.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: httproute-multiple-parentrefs
spec:
  description: |
    This test validates that the hybrid gateway controller correctly
    processes an HTTPRoute with multiple ParentRefs, creating Kong
    resources for each Gateway/ControlPlane.

  bindings:
    # Common bindings.
    - name: test_name
      value: ($namespace)
    - name: konnect_token
      value: (env('KONNECT_TOKEN'))
    - name: konnect_url
      value: (env('KONNECT_SERVER_URL') || 'eu.api.konghq.tech')
    - name: auth_secret_name
      value: (join('-', [($test_name), 'konnect-auth-secret']))
    - name: auth_secret_namespace
      value: ($namespace)
    - name: konnect_auth_name
      value: (join('-', [($test_name), 'konnect-api-auth']))
    - name: konnect_auth_namespace
      value: ($namespace)
    - name: gateway_image
      value: (env('GATEWAY_IMAGE') || 'kong/kong-gateway:3.12')
    - name: konnect_api_auth_namespace
      value: ($namespace)
    
    # TLS configuration.
    - name: sni_hostname_1
      value: (join('.', ['*', 'gw1', ($test_name), 'example.com']))
    - name: sni_hostname_2
      value: (join('.', ['*', 'gw2', ($test_name), 'example.com']))
    - name: cert_secret_name_1
      value: test-tls-secret-1
    - name: cert_secret_name_2
      value: test-tls-secret-2
    - name: cert_secret_namespace
      value: ($namespace)
    - name: listener_https_port
      value: 443
    - name: listener_http_port
      value: 80
    
    # Gateway 1 bindings.
    - name: gateway_name_1
      value: (join('-', [($test_name), 'gateway-1']))
    - name: gateway_namespace_1
      value: ($namespace)
    
    # Gateway 2 bindings.
    - name: gateway_name_2
      value: (join('-', [($test_name), 'gateway-2']))
    - name: gateway_namespace_2
      value: ($namespace)
    
    # HTTPRoute bindings.
    - name: fqdn
      value: (join('.', ['httpbin', ($test_name), 'example.com']))
    - name: fqdn_1
      value: (join('.', ['httpbin', 'gw1', ($test_name), 'example.com']))
    - name: fqdn_2
      value: (join('.', ['httpbin', 'gw2', ($test_name), 'example.com']))
    - name: http_route_name
      value: (join('-', [($test_name), 'multi-parentref-route']))
    - name: http_route_namespace
      value: ($namespace)
    - name: http_route_single_name
      value: (join('-', [($test_name), 'single-parentref-route']))
    - name: http_route_single_namespace
      value: ($namespace)
    - name: route_path
      value: "/get"
    - name: route_path_single
      value: "/status/200"
    - name: http_method
      value: "GET"
    
    # Backend service bindings.
    - name: httpbin_deployment_name
      value: (join('-', [($test_name), 'httpbin']))
    - name: httpbin_deployment_namespace
      value: ($namespace)

  steps:
    # Step 1: Create TLS secret for Gateway 1.
    - name: Create-tls-secret-1
      description: Create TLS Secret for Gateway 1
      use:
        template: ../../common/_step_templates/apply-assert-tlsSecret.yaml
      bindings:
        - name: sni_hostname
          value: ($sni_hostname_1)
        - name: cert_secret_name
          value: ($cert_secret_name_1)

    # Step 2: Create TLS secret for Gateway 2.
    - name: Create-tls-secret-2
      description: Create TLS Secret for Gateway 2
      use:
        template: ../../common/_step_templates/apply-assert-tlsSecret.yaml
      bindings:
        - name: sni_hostname
          value: ($sni_hostname_2)
        - name: cert_secret_name
          value: ($cert_secret_name_2)

    # Step 3a: Create the secret for Konnect authentication.
    - name: Create-auth-secret
      description: Create Secret with Konnect token for KonnectAPIAuthConfiguration.
      use:
        template: ../../common/_step_templates/apply-assert-konnectAuthSecret.yaml

    # Step 3b: Create the KonnectAPIAuthConfiguration.
    - name: Create-konnect-api-auth
      description: Create KonnectAPIAuthConfiguration for the test
      use:
        template: ../../common/_step_templates/apply-assert-konnectAPIAuthConfiguration-secretref.yaml

    # Step 4: Create GatewayConfiguration for Gateway 1.
    - name: Create-gateway-configuration-1
      description: Create GatewayConfiguration for Gateway 1
      use:
        template: ../../common/_step_templates/apply-assert-gatewayConfiguration.yaml

    # Step 5: Create GatewayClass for Gateway 1.
    - name: Create-gateway-class-1
      description: Create GatewayClass for Gateway 1
      use:
        template: ../../common/_step_templates/apply-assert-gatewayClass.yaml

    # Step 6: Create Gateway 1.
    - name: Create-gateway-1
      description: Create first Gateway with TLS listener
      use:
        template: ../../common/_step_templates/apply-assert-gateway.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: sni_hostname
          value: ($sni_hostname_1)
        - name: cert_secret_name
          value: ($cert_secret_name_1)

    # Step 7: Assert KonnectGatewayControlPlane for Gateway 1.
    - name: Assert-konnect-gateway-control-plane-1
      description: Assert KonnectGatewayControlPlane for Gateway 1
      use:
        template: ../../common/_step_templates/assert-konnectGatewayControlPlane.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)

    # Step 8: Create Gateway 2 (uses same GatewayClass as Gateway 1).
    - name: Create-gateway-2
      description: Create second Gateway with TLS listener
      use:
        template: ../../common/_step_templates/apply-assert-gateway.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: sni_hostname
          value: ($sni_hostname_2)
        - name: cert_secret_name
          value: ($cert_secret_name_2)

    # Step 9: Assert KonnectGatewayControlPlane for Gateway 2.
    - name: Assert-konnect-gateway-control-plane-2
      description: Assert KonnectGatewayControlPlane for Gateway 2
      use:
        template: ../../common/_step_templates/assert-konnectGatewayControlPlane.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: gateway_namespace
          value: ($gateway_namespace_2)

    # Step 10: Assert KongCertificate for Gateway 1.
    - name: Assert-kong-certificate-1
      description: Assert KongCertificate for Gateway 1
      use:
        template: ../../common/_step_templates/assert-kongCertificate.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: cert_secret_name
          value: ($cert_secret_name_1)

    # Step 11: Assert KongSNI for Gateway 1.
    - name: Assert-kong-sni-1
      description: Assert KongSNI for Gateway 1
      use:
        template: ../../common/_step_templates/assert-kongSNI.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: sni_hostname
          value: ($sni_hostname_1)
        - name: resource_type
          value: "kongcertificates.configuration.konghq.com"

    # Step 12: Assert KongCertificate for Gateway 2.
    - name: Assert-kong-certificate-2
      description: Assert KongCertificate for Gateway 2
      use:
        template: ../../common/_step_templates/assert-kongCertificate.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: gateway_namespace
          value: ($gateway_namespace_2)
        - name: cert_secret_name
          value: ($cert_secret_name_2)

    # Step 13: Assert KongSNI for Gateway 2.
    - name: Assert-kong-sni-2
      description: Assert KongSNI for Gateway 2
      use:
        template: ../../common/_step_templates/assert-kongSNI.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: gateway_namespace
          value: ($gateway_namespace_2)
        - name: sni_hostname
          value: ($sni_hostname_2)
        - name: resource_type
          value: "kongcertificates.configuration.konghq.com"

    # Step 14: Create httpbin service.
    - name: Create-httpbin-service
      description: Create httpbin service as backend
      use:
        template: ../../common/_step_templates/apply-assert-httpbinService.yaml

    # Step 15: Create HTTPRoute with multiple ParentRefs.
    - name: Create-httproute-multiple-parentrefs
      description: Create HTTPRoute referencing both Gateways
      try:
        - apply:
            file: 01-httpRoute-multiple-parentrefs.yaml
        - assert:
            file: 02-httpRoute-multiple-parentrefs-assert.yaml

    # Step 16: Assert KongRoute for Gateway 1.
    - name: Assert-kong-route-gateway-1
      description: Assert KongRoute created for Gateway 1
      use:
        template: ../../common/_step_templates/assert-kongRoute.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: route_paths
          value:
            - "~/get$"
            - "/get/"
        - name: strip_path
          value: true
        - name: resource_type
          value: "kongservices.configuration.konghq.com"

    # Step 17: Assert KongService for Gateway 1.
    - name: Assert-kong-service-gateway-1
      description: Assert KongService created for Gateway 1
      use:
        template: ../../common/_step_templates/assert-kongService.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)

    # Step 18: Assert KongRoute for Gateway 2.
    - name: Assert-kong-route-gateway-2
      description: Assert KongRoute created for Gateway 2
      use:
        template: ../../common/_step_templates/assert-kongRoute.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: gateway_namespace
          value: ($gateway_namespace_2)
        - name: route_paths
          value:
            - "~/get$"
            - "/get/"
        - name: strip_path
          value: true
        - name: resource_type
          value: "kongservices.configuration.konghq.com"

    # Step 19: Assert KongService for Gateway 2.
    - name: Assert-kong-service-gateway-2
      description: Assert KongService created for Gateway 2
      use:
        template: ../../common/_step_templates/assert-kongService.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: gateway_namespace
          value: ($gateway_namespace_2)

    # Step 20: Assert KongUpstream for Gateway 1.
    - name: Assert-kong-upstream-gateway-1
      description: Assert KongUpstream created for Gateway 1
      use:
        template: ../../common/_step_templates/assert-kongUpstream.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)

    # Step 21: Assert KongTarget for Gateway 1.
    - name: Assert-kong-target-gateway-1
      description: Assert KongTarget created for Gateway 1
      use:
        template: ../../common/_step_templates/assert-kongTarget.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: resource_type
          value: "kongupstreams.configuration.konghq.com"
        - name: target_weight
          value: 1

    # Step 22: Assert KongUpstream for Gateway 2.
    - name: Assert-kong-upstream-gateway-2
      description: Assert KongUpstream created for Gateway 2
      use:
        template: ../../common/_step_templates/assert-kongUpstream.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: gateway_namespace
          value: ($gateway_namespace_2)

    # Step 23: Assert KongTarget for Gateway 2.
    - name: Assert-kong-target-gateway-2
      description: Assert KongTarget created for Gateway 2
      use:
        template: ../../common/_step_templates/assert-kongTarget.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: gateway_namespace
          value: ($gateway_namespace_2)
        - name: resource_type
          value: "kongupstreams.configuration.konghq.com"
        - name: target_weight
          value: 1

    # Step 24: Verify HTTPS traffic from host through Gateway 1.
    - name: Verify-HTTPS-traffic-from-host-gateway-1
      description: Verify HTTPS traffic from host flows through Gateway 1
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: fqdn
          value: ($fqdn_1)
        - name: route_path
          value: ($route_path)
        - name: http_method
          value: ($http_method)
        - name: insecure
          value: "true"

    # Step 25: Verify HTTPS traffic from cluster through Gateway 1.
    - name: Verify-HTTPS-traffic-from-cluster-gateway-1
      description: Verify HTTPS traffic from cluster flows through Gateway 1
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-cluster.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: fqdn
          value: ($fqdn_1)
        - name: route_path
          value: ($route_path)
        - name: http_method
          value: ($http_method)
        - name: insecure
          value: "true"

    # Step 26: Verify HTTP traffic from host through Gateway 1.
    - name: Verify-HTTP-traffic-from-host-gateway-1
      description: Verify HTTP traffic from host flows through Gateway 1
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: route_path
          value: ($route_path)
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn_1)

    # Step 27: Verify HTTP traffic from cluster through Gateway 1.
    - name: Verify-HTTP-traffic-from-cluster-gateway-1
      description: Verify HTTP traffic from cluster flows through Gateway 1
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-cluster.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: route_path
          value: ($route_path)
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn_1)

    # Step 28: Verify HTTPS traffic from host through Gateway 2.
    - name: Verify-HTTPS-traffic-from-host-gateway-2
      description: Verify HTTPS traffic from host flows through Gateway 2
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: gateway_namespace
          value: ($gateway_namespace_2)
        - name: fqdn
          value: ($fqdn_2)
        - name: route_path
          value: ($route_path)
        - name: http_method
          value: ($http_method)
        - name: insecure
          value: "true"

    # Step 29: Verify HTTPS traffic from cluster through Gateway 2.
    - name: Verify-HTTPS-traffic-from-cluster-gateway-2
      description: Verify HTTPS traffic from cluster flows through Gateway 2
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-cluster.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: gateway_namespace
          value: ($gateway_namespace_2)
        - name: fqdn
          value: ($fqdn_2)
        - name: route_path
          value: ($route_path)
        - name: http_method
          value: ($http_method)
        - name: insecure
          value: "true"

    # Step 30: Verify HTTP traffic from host through Gateway 2.
    - name: Verify-HTTP-traffic-from-host-gateway-2
      description: Verify HTTP traffic from host flows through Gateway 2
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: gateway_namespace
          value: ($gateway_namespace_2)
        - name: route_path
          value: ($route_path)
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn_2)

    # Step 31: Verify HTTP traffic from cluster through Gateway 2.
    - name: Verify-HTTP-traffic-from-cluster-gateway-2
      description: Verify HTTP traffic from cluster flows through Gateway 2
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-cluster.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_2)
        - name: gateway_namespace
          value: ($gateway_namespace_2)
        - name: route_path
          value: ($route_path)
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn_2)

    # Step 32: Create HTTPRoute with single ParentRef (Gateway 1 only).
    - name: Create-httproute-single-parentref
      description: Create HTTPRoute with single ParentRef to Gateway 1
      try:
        - apply:
            file: 03-httpRoute-single-parentref.yaml
        - assert:
            file: 04-httpRoute-single-parentref-assert.yaml

    # Step 33: Assert KongRoute for single-parent HTTPRoute.
    - name: Assert-kong-route-single-parent
      description: Assert KongRoute created for single-parent HTTPRoute
      use:
        template: ../../common/_step_templates/assert-kongRoute.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: http_route_name
          value: ($http_route_single_name)
        - name: route_paths
          value:
            - "~/status/200$"
            - "/status/200/"
        - name: strip_path
          value: true
        - name: resource_type
          value: "kongservices.configuration.konghq.com"

    # Step 34: Assert KongService for single-parent HTTPRoute.
    - name: Assert-kong-service-single-parent
      description: Assert KongService created for single-parent HTTPRoute
      use:
        template: ../../common/_step_templates/assert-kongService.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: http_route_name
          value: ($http_route_single_name)

    # Step 35: Assert KongUpstream for single-parent HTTPRoute.
    - name: Assert-kong-upstream-single-parent
      description: Assert KongUpstream created for single-parent HTTPRoute
      use:
        template: ../../common/_step_templates/assert-kongUpstream.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: http_route_name
          value: ($http_route_single_name)

    # Step 36: Assert KongTarget for single-parent HTTPRoute.
    - name: Assert-kong-target-single-parent
      description: Assert KongTarget created for single-parent HTTPRoute
      use:
        template: ../../common/_step_templates/assert-kongTarget.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: http_route_name
          value: ($http_route_single_name)
        - name: resource_type
          value: "kongupstreams.configuration.konghq.com"
        - name: target_weight
          value: 1

    # Step 37: Verify HTTPS traffic for single-parent route.
    - name: Verify-HTTPS-traffic-single-parent
      description: Verify HTTPS traffic for single-parent HTTPRoute through Gateway 1
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-host.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: fqdn
          value: ($fqdn_1)
        - name: route_path
          value: ($route_path_single)
        - name: http_method
          value: ($http_method)
        - name: insecure
          value: "true"

    # Step 38: Verify HTTPS traffic from cluster for single-parent route.
    - name: Verify-HTTPS-traffic-from-cluster-single-parent
      description: Verify HTTPS traffic from cluster for single-parent HTTPRoute through Gateway 1
      use:
        template: ../../common/_step_templates/verify-https-traffic-from-cluster.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: fqdn
          value: ($fqdn_1)
        - name: route_path
          value: ($route_path_single)
        - name: http_method
          value: ($http_method)
        - name: insecure
          value: "true"

    # Step 39: Verify HTTP traffic from host for single-parent route.
    - name: Verify-HTTP-traffic-from-host-single-parent
      description: Verify HTTP traffic from host for single-parent HTTPRoute through Gateway 1
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-host.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: route_path
          value: ($route_path_single)
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn_1)

    # Step 40: Verify HTTP traffic from cluster for single-parent route.
    - name: Verify-HTTP-traffic-from-cluster-single-parent
      description: Verify HTTP traffic from cluster for single-parent HTTPRoute through Gateway 1
      use:
        template: ../../common/_step_templates/verify-http-traffic-from-cluster.yaml
      bindings:
        - name: gateway_name
          value: ($gateway_name_1)
        - name: gateway_namespace
          value: ($gateway_namespace_1)
        - name: route_path
          value: ($route_path_single)
        - name: listener_http_port
          value: "80"
        - name: host_header
          value: ($fqdn_1)

  catch:
    # Capture debug snapshot on test failure for CI debugging.
    - description: Capture debug snapshot
      script:
        env:
          - name: TEST_NAME
            value: hybridgateway-httproute-multiple-parentrefs
          - name: NAMESPACE
            value: ($namespace)
          - name: OPERATOR_NAMESPACE
            value: kong-system
        content: |
          bash ../../common/scripts/debug_snapshot.sh
