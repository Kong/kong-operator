# Template for creating and asserting a KonnectAPIAuthConfiguration.
#
# Required bindings:
#   - konnect_auth_name: Name of the KonnectAPIAuthConfiguration to create.
#   - konnect_auth_namespace: Namespace where the KonnectAPIAuthConfiguration will be created.
#   - auth_secret_name: Name of the Secret to reference.
#   - auth_secret_namespace: Namespace of the Secret to reference.
#   - konnect_url: Konnect server URL (e.g., "eu.api.konghq.tech").
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: StepTemplate
metadata:
  name: apply-assert-konnect-auth
spec:
  try:
    - apply:
        resource:
          apiVersion: konnect.konghq.com/v1alpha1
          kind: KonnectAPIAuthConfiguration
          metadata:
            name: ($konnect_auth_name)
            namespace: ($konnect_auth_namespace)
          spec:
            type: secretRef
            secretRef:
              name: ($auth_secret_name)
              namespace: ($auth_secret_namespace)
            serverURL: ($konnect_url)
    - assert:
        resource:
          apiVersion: konnect.konghq.com/v1alpha1
          kind: KonnectAPIAuthConfiguration
          metadata:
            name: ($konnect_auth_name)
            namespace: ($konnect_auth_namespace)
          spec:
            type: secretRef
            secretRef:
              name: ($auth_secret_name)
              namespace: ($auth_secret_namespace)
            serverURL: ($konnect_url)
          # Assert that the resource was accepted (adjust based on actual status field)
          status:
            (conditions[?type == 'APIAuthValid']):
              - status: 'True'
                reason: Valid
            serverURL: (join('', ['https://', ($konnect_url)]))
