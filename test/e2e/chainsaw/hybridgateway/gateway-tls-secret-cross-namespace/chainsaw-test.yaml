# Gateway TLS secret cross-namespace reference test scenario.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: gateway-tls-secret-cross-namespace
spec:
  description: |
    This test validates cross-namespace Gateway to Secret references for TLS listeners.
    It verifies the Gateway listener ResolvedRefs condition is False without a
    ReferenceGrant and that KongCertificate/KongSNI are not provisioned. After
    creating a ReferenceGrant, it asserts the Gateway is programmed and the
    KongCertificate/KongSNI exist but are not programmed until a KongReferenceGrant
    is added.

  bindings:
    # Common bindings.
    - name: test_name
      value: ($namespace)
    - name: konnect_token
      value: (env('KONNECT_TOKEN'))
    - name: sni_hostname
      value: (join('.', ['*', ($test_name), 'example.com']))
    - name: cert_secret_name
      value: test-tls-secret
    - name: secret_namespace
      value: (join('-', [($namespace), 'tls-secrets']))
    - name: cert_secret_namespace
      value: ($secret_namespace)
    - name: listener_https_port
      value: 443
    - name: listener_http_port
      value: 80
    - name: konnect_url
      value: (env('KONNECT_SERVER_URL') || 'eu.api.konghq.tech')
    - name: auth_secret_name
      value: (join('-', [($test_name), 'konnect-auth-secret']))
    - name: auth_secret_namespace
      value: ($namespace)
    - name: konnect_auth_name
      value: (join('-', [($test_name), 'konnect-api-auth']))
    - name: konnect_auth_namespace
      value: ($namespace)
    - name: gateway_image
      value: (env('GATEWAY_IMAGE') || 'kong/kong-gateway:3.12')
    - name: gateway_name
      value: (join('-', [($test_name), 'gateway']))
    - name: gateway_namespace
      value: ($namespace)
    - name: reference_grant_name
      value: (join('-', [($test_name), 'gateway-secret-reference-grant']))
    - name: reference_grant_namespace
      value: ($secret_namespace)
    - name: kong_reference_grant_name
      value: (join('-', [($test_name), 'kong-secret-reference-grant']))
    - name: kong_reference_grant_namespace
      value: ($cert_secret_namespace)

  steps:
    # Step 1: Create the namespace for TLS secrets.
    - name: 1-create-secret-namespace
      description: Create the namespace that holds the TLS secret
      use:
        template: ../../common/_step_templates/apply-assert-namespace.yaml
      bindings:
        - name: namespace_name
          value: ($secret_namespace)

    # Step 2: Create the TLS secret in the separate namespace.
    - name: 2-create-tls-secret
      description: Create TLS Secret in a different namespace for the Gateway TLS listener
      use:
        template: ../../common/_step_templates/apply-assert-tlsSecret.yaml

    # Step 3a: Create the secret for Konnect authentication.
    - name: 3a-create-auth-secret
      description: Create Secret with Konnect token for KonnectAPIAuthConfiguration
      use:
        template: ../../common/_step_templates/apply-assert-konnectAuthSecret.yaml

    # Step 3b: Create the KonnectAPIAuthConfiguration to authenticate with Konnect.
    - name: 3b-create-konnect-api-auth
      description: Create KonnectAPIAuthConfiguration for the test
      use:
        template: ../../common/_step_templates/apply-assert-konnectAPIAuthConfiguration-secretref.yaml

    # Step 4: Create the GatewayConfiguration that defines the hybrid gateway setup.
    - name: 4-create-gateway-configuration
      description: Create GatewayConfiguration for the test
      use:
        template: ../../common/_step_templates/apply-assert-gatewayConfiguration.yaml

    # Step 5: Create the GatewayClass that will be used by the Gateway.
    - name: 5-create-gateway-class
      description: Create GatewayClass for the test
      use:
        template: ../../common/_step_templates/apply-assert-gatewayClass.yaml

    # Step 6: Create the Gateway with a cross-namespace TLS secret reference.
    - name: 6-create-gateway
      description: Create Gateway with TLS listener referencing a secret in another namespace
      try:
        - apply:
            file: 01-gateway.yaml

    # Step 7: Assert Gateway listener ResolvedRefs is False without ReferenceGrant.
    - name: 7-assert-gateway-resolvedrefs-false
      description: Verify Gateway listener ResolvedRefs is False before ReferenceGrant
      try:
        - assert:
            file: 02-assert-gateway-resolvedrefs-false.yaml

    # Step 8: Verify KongCertificate has not been created yet.
    - name: 8-assert-no-kongcertificate
      description: Verify no KongCertificate exists before ReferenceGrant
      use:
        template: ../../common/_step_templates/assert-no-kong-resource.yaml
      bindings:
        - name: resource_type
          value: kongcertificates.configuration.konghq.com
        - name: gateway_name
          value: ($gateway_name)
        - name: gateway_namespace
          value: ($gateway_namespace)
        - name: namespace
          value: ($gateway_namespace)

    # Step 9: Verify KongSNI has not been created yet.
    - name: 9-assert-no-kongsni
      description: Verify no KongSNI exists before ReferenceGrant
      try:
        - script:
            env:
              - name: NAMESPACE
                value: ($gateway_namespace)
              - name: GATEWAY_NAME
                value: ($gateway_name)
            content: |
              bash ../../common/scripts/assert_no_kongsni.sh

    # Step 10: Create ReferenceGrant to allow Gateway -> Secret cross-namespace reference.
    - name: 10-create-reference-grant
      description: Create ReferenceGrant to allow the Gateway to reference the TLS secret
      use:
        template: ../../common/_step_templates/apply-assert-referencegrant.yaml
      bindings:
        - name: reference_grant_name
          value: ($reference_grant_name)
        - name: reference_grant_namespace
          value: ($reference_grant_namespace)
        - name: from
          value:
            - group: gateway.networking.k8s.io
              kind: Gateway
              namespace: ($gateway_namespace)
        - name: to
          value:
            - group: ""
              kind: Secret
              name: ($cert_secret_name)

    # Step 11: Assert Gateway is programmed with ResolvedRefs after ReferenceGrant.
    - name: 11-assert-gateway-programmed-with-resolvedrefs
      description: Verify Gateway is programmed and listener ResolvedRefs is True after ReferenceGrant
      try:
        - assert:
            file: 03-assert-gateway-programmed-with-resolvedrefs.yaml

    # Step 12: Verify that the KonnectGatewayControlPlane is created and programmed.
    - name: 12-assert-konnect-gateway-control-plane
      description: Assert that the KonnectGatewayControlPlane resource is created and synchronized
      use:
        template: ../../common/_step_templates/assert-konnectGatewayControlPlane.yaml

    # Step 13: Assert KongCertificate exists but is not programmed.
    - name: 13-assert-kong-certificate-not-programmed
      description: Verify KongCertificate exists but is not programmed before KongReferenceGrant
      try:
        - script:
            env:
              - name: GATEWAY_NAME
                value: ($gateway_name)
              - name: GATEWAY_NAMESPACE
                value: ($gateway_namespace)
            content: |
              bash ../../common/scripts/konnectGatewayControlplane_name.sh
            outputs:
              - name: konnectgatewaycontrolplane_name
                value: (json_parse($stdout).cp_name)
        - assert:
            file: 04-assert-kongcertificate-not-programmed.yaml

    # Step 14: Assert KongSNI exists but is not programmed.
    - name: 14-assert-kong-sni-not-programmed
      description: Verify KongSNI exists but is not programmed before KongReferenceGrant
      try:
        - script:
            env:
              - name: GATEWAY_NAME
                value: ($gateway_name)
              - name: GATEWAY_NAMESPACE
                value: ($gateway_namespace)
              - name: NAMESPACE
                value: ($gateway_namespace)
              - name: RESOURCE_TYPE
                value: kongcertificates.configuration.konghq.com
            content: |
              bash ../../common/scripts/kongResource_name.sh
            outputs:
              - name: certificate_name
                value: (json_parse($stdout).resource_name)
        - assert:
            file: 05-assert-kongsni-not-programmed.yaml

    # Step 15: Create KongReferenceGrant to allow KongCertificate -> Secret cross-namespace reference.
    - name: 15-create-kong-reference-grant
      description: Create KongReferenceGrant to allow KongCertificate to reference the TLS secret
      use:
        template: ../../common/_step_templates/apply-assert-kongreferencegrant.yaml
      bindings:
        - name: kong_reference_grant_name
          value: ($kong_reference_grant_name)
        - name: kong_reference_grant_namespace
          value: ($kong_reference_grant_namespace)
        - name: from
          value:
            - group: configuration.konghq.com
              kind: KongCertificate
              namespace: ($gateway_namespace)
        - name: to
          value:
            - group: core
              kind: Secret
              name: ($cert_secret_name)

    # Step 16: Verify that the KongCertificate is programmed after KongReferenceGrant.
    - name: 16-assert-kong-certificate-programmed
      description: Assert that the KongCertificate resource is programmed for the TLS secret
      use:
        template: ../../common/_step_templates/assert-kongCertificate.yaml
      bindings:
        - name: namespace
          value: ($gateway_namespace)

    # Step 17: Verify that the KongSNI is programmed after KongReferenceGrant.
    - name: 17-assert-kong-sni-programmed
      description: Assert that the KongSNI resource is programmed for the SNI hostname
      use:
        template: ../../common/_step_templates/assert-kongSNI.yaml
      bindings:
        - name: namespace
          value: ($gateway_namespace)
        - name: resource_type
          value: kongcertificates.configuration.konghq.com
  
  catch:
    # Capture debug snapshot on test failure for CI debugging.
    - description: Capture debug snapshot
      script:
        env:
          - name: TEST_NAME
            value: hybridgateway-gateway-tls-secret-cross-namespace
          - name: NAMESPACE
            value: ($namespace)
          - name: ADDITIONAL_NAMESPACES
            value: ($secret_namespace)
          - name: OPERATOR_NAMESPACE
            value: kong-system
        content: |
          bash ../../common/scripts/debug_snapshot.sh
